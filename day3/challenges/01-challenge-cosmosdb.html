<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Challenge 01: Cosmos DB | Azure Developer College</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/trainingdays/assets/css/0.styles.8d7a09fd.css" as="style"><link rel="preload" href="/trainingdays/assets/js/app.e8a6fdbf.js" as="script"><link rel="preload" href="/trainingdays/assets/js/3.9b3cf7d1.js" as="script"><link rel="preload" href="/trainingdays/assets/js/6.49058ca4.js" as="script"><link rel="prefetch" href="/trainingdays/assets/js/10.5e63eee4.js"><link rel="prefetch" href="/trainingdays/assets/js/11.52cdb15c.js"><link rel="prefetch" href="/trainingdays/assets/js/12.dd68cce1.js"><link rel="prefetch" href="/trainingdays/assets/js/13.968f15e4.js"><link rel="prefetch" href="/trainingdays/assets/js/14.6107e61f.js"><link rel="prefetch" href="/trainingdays/assets/js/15.74de6942.js"><link rel="prefetch" href="/trainingdays/assets/js/16.bf550880.js"><link rel="prefetch" href="/trainingdays/assets/js/17.25c2442d.js"><link rel="prefetch" href="/trainingdays/assets/js/18.df448a3a.js"><link rel="prefetch" href="/trainingdays/assets/js/19.57fc59b2.js"><link rel="prefetch" href="/trainingdays/assets/js/2.5f4f93ed.js"><link rel="prefetch" href="/trainingdays/assets/js/20.b16a4364.js"><link rel="prefetch" href="/trainingdays/assets/js/21.f120af84.js"><link rel="prefetch" href="/trainingdays/assets/js/22.a29f663d.js"><link rel="prefetch" href="/trainingdays/assets/js/23.2e9fa4d5.js"><link rel="prefetch" href="/trainingdays/assets/js/24.df3c97d4.js"><link rel="prefetch" href="/trainingdays/assets/js/25.d7157d1b.js"><link rel="prefetch" href="/trainingdays/assets/js/26.8b935eca.js"><link rel="prefetch" href="/trainingdays/assets/js/27.fab398a7.js"><link rel="prefetch" href="/trainingdays/assets/js/28.f45e3c7c.js"><link rel="prefetch" href="/trainingdays/assets/js/29.1ebc26ec.js"><link rel="prefetch" href="/trainingdays/assets/js/30.6728cb2f.js"><link rel="prefetch" href="/trainingdays/assets/js/31.0447b951.js"><link rel="prefetch" href="/trainingdays/assets/js/32.7ba3de54.js"><link rel="prefetch" href="/trainingdays/assets/js/33.1886053c.js"><link rel="prefetch" href="/trainingdays/assets/js/34.71397a5c.js"><link rel="prefetch" href="/trainingdays/assets/js/35.3f4903ee.js"><link rel="prefetch" href="/trainingdays/assets/js/36.ca5c6cd3.js"><link rel="prefetch" href="/trainingdays/assets/js/37.150f3aea.js"><link rel="prefetch" href="/trainingdays/assets/js/38.267b0401.js"><link rel="prefetch" href="/trainingdays/assets/js/39.b63e5745.js"><link rel="prefetch" href="/trainingdays/assets/js/4.51ff6f02.js"><link rel="prefetch" href="/trainingdays/assets/js/40.ccce5e2d.js"><link rel="prefetch" href="/trainingdays/assets/js/41.8d1a41f2.js"><link rel="prefetch" href="/trainingdays/assets/js/42.b2565944.js"><link rel="prefetch" href="/trainingdays/assets/js/43.b9bb36ce.js"><link rel="prefetch" href="/trainingdays/assets/js/44.0cb215c3.js"><link rel="prefetch" href="/trainingdays/assets/js/45.ed0b28e2.js"><link rel="prefetch" href="/trainingdays/assets/js/46.d7dc415d.js"><link rel="prefetch" href="/trainingdays/assets/js/47.94e659f8.js"><link rel="prefetch" href="/trainingdays/assets/js/48.22da67bb.js"><link rel="prefetch" href="/trainingdays/assets/js/49.d0cc21bd.js"><link rel="prefetch" href="/trainingdays/assets/js/5.8a1a1dd9.js"><link rel="prefetch" href="/trainingdays/assets/js/50.fc76ce90.js"><link rel="prefetch" href="/trainingdays/assets/js/51.49e6933d.js"><link rel="prefetch" href="/trainingdays/assets/js/52.b3007d12.js"><link rel="prefetch" href="/trainingdays/assets/js/53.ce74ac77.js"><link rel="prefetch" href="/trainingdays/assets/js/54.0ae1433b.js"><link rel="prefetch" href="/trainingdays/assets/js/55.84f6f655.js"><link rel="prefetch" href="/trainingdays/assets/js/56.8abf9a8b.js"><link rel="prefetch" href="/trainingdays/assets/js/57.5f879cc0.js"><link rel="prefetch" href="/trainingdays/assets/js/58.143be8bb.js"><link rel="prefetch" href="/trainingdays/assets/js/59.48d8acfe.js"><link rel="prefetch" href="/trainingdays/assets/js/60.a173b602.js"><link rel="prefetch" href="/trainingdays/assets/js/61.04f45b6d.js"><link rel="prefetch" href="/trainingdays/assets/js/62.c3ecf647.js"><link rel="prefetch" href="/trainingdays/assets/js/63.ad717965.js"><link rel="prefetch" href="/trainingdays/assets/js/64.3e451a8e.js"><link rel="prefetch" href="/trainingdays/assets/js/65.a310d4e8.js"><link rel="prefetch" href="/trainingdays/assets/js/66.91ad5d91.js"><link rel="prefetch" href="/trainingdays/assets/js/67.bdfc270a.js"><link rel="prefetch" href="/trainingdays/assets/js/68.7805630f.js"><link rel="prefetch" href="/trainingdays/assets/js/69.9a6edb47.js"><link rel="prefetch" href="/trainingdays/assets/js/7.3ee5fb68.js"><link rel="prefetch" href="/trainingdays/assets/js/70.2e5214af.js"><link rel="prefetch" href="/trainingdays/assets/js/71.0ed1ea53.js"><link rel="prefetch" href="/trainingdays/assets/js/72.05b27471.js"><link rel="prefetch" href="/trainingdays/assets/js/73.5cd028ca.js"><link rel="prefetch" href="/trainingdays/assets/js/74.cd61fe8d.js"><link rel="prefetch" href="/trainingdays/assets/js/75.8c8f40ca.js"><link rel="prefetch" href="/trainingdays/assets/js/76.50f7afaf.js"><link rel="prefetch" href="/trainingdays/assets/js/77.a0e160e0.js"><link rel="prefetch" href="/trainingdays/assets/js/78.c8465bf5.js"><link rel="prefetch" href="/trainingdays/assets/js/79.458fd2c0.js"><link rel="prefetch" href="/trainingdays/assets/js/8.3f86f0a0.js"><link rel="prefetch" href="/trainingdays/assets/js/80.454f4426.js"><link rel="prefetch" href="/trainingdays/assets/js/81.ed2d010d.js"><link rel="prefetch" href="/trainingdays/assets/js/82.cd4bb1c0.js"><link rel="prefetch" href="/trainingdays/assets/js/83.e3b63896.js"><link rel="prefetch" href="/trainingdays/assets/js/84.af75ea47.js"><link rel="prefetch" href="/trainingdays/assets/js/85.728f265c.js"><link rel="prefetch" href="/trainingdays/assets/js/86.e93b6d39.js"><link rel="prefetch" href="/trainingdays/assets/js/87.d5748615.js"><link rel="prefetch" href="/trainingdays/assets/js/9.b9da79d5.js">
    <link rel="stylesheet" href="/trainingdays/assets/css/0.styles.8d7a09fd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/trainingdays/" class="home-link router-link-active"><!----> <span class="site-name">Azure Developer College</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/trainingdays/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/trainingdays/day1/" class="sidebar-link">Day 1 Azure Fundamentals &amp; Infrastructure</a></li><li><a href="/trainingdays/day2/" class="sidebar-link">Day 2 Azure Development</a></li><li><a href="/trainingdays/day3/" aria-current="page" class="sidebar-link">Day 3 Data and AI</a></li><li><a href="/trainingdays/day4/" class="sidebar-link">Day 4 DevOps and Monitoring</a></li><li><a href="/trainingdays/day5/" class="sidebar-link">Day 5 Identity and Architecture</a></li><li><a href="/trainingdays/day6/" class="sidebar-link">Day 6 Containerization</a></li><li><a href="/trainingdays/day7/" class="sidebar-link">Day 7 Kubernetes</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="challenge-01-cosmos-db"><a href="#challenge-01-cosmos-db" class="header-anchor">#</a> Challenge 01: Cosmos DB</h1> <p>‚è≤Ô∏è <em>Est. time to complete: 60 min.</em> ‚è≤Ô∏è</p> <h2 id="here-is-what-you-will-learn-üéØ"><a href="#here-is-what-you-will-learn-üéØ" class="header-anchor">#</a> Here is what you will learn üéØ</h2> <p>In this challenge you will learn how to:</p> <ul><li>Create a Cosmos DB account</li> <li>Add data and query via the data explorer</li> <li>Learn about partitions and the effect of cross-partition queries</li> <li>Use the Cosmos DB change feed</li> <li>Monitor your database</li></ul> <h2 id="table-of-contents"><a href="#table-of-contents" class="header-anchor">#</a> Table Of Contents</h2> <ol><li><a href="#create-a-comsos-db-account-database-and-containers">Create a Comsos DB Account, Database and Containers</a></li> <li><a href="#add-and-query-data">Add and query data</a></li> <li><a href="#use-the-cosmos-db-change-feed">Use the Cosmos DB Change Feed</a></li> <li><a href="#monitor-cosmos-db">Monitor Cosmos DB</a></li> <li><a href="#azure-samples">Azure Samples</a></li> <li><a href="#cleanup">Cleanup</a></li></ol> <h2 id="create-a-comsos-db-account-database-and-containers"><a href="#create-a-comsos-db-account-database-and-containers" class="header-anchor">#</a> Create a Comsos DB Account, Database and Containers</h2> <p>Before we start creating a database account in Azure, let's have a brief look at the resource model of Cosmos DB. It is made of the following objects:</p> <ul><li><em>Account</em>: manages one or more databases</li> <li><em>Database</em>: manages users, permissions and containers</li> <li><em>Container</em>: a schema-agnostic container of user-generated JSON items and JavaScript based stored procedures, triggers and user-defined-functions (UDFs)</li> <li><em>Item</em>: user-generated document stored in a container</li></ul> <p><img src="/trainingdays/assets/img/resourcemodel.1ea193f0.png" alt="Cosmos DB Resource Model" title="Comsos DB Resource Model"></p> <p>To create a Cosmos DB account, database and the corresponding containers we will use in this challenge, you have two options:</p> <ul><li><a href="#option-1-azure-portal">Azure Portal</a></li> <li><a href="#option-2-azure-bicep">Azure Bicep</a></li></ul> <p>Both are decribed in the next chapters, choose only one of them.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù The &quot;Bicep&quot; option is much faster, because it will create all the objects automatically at once. If you want to go with that one, please also have a look at the &quot;Create View&quot; in the portal to make yourself familiar with all the settings you can adjust for a Cosmos DB account, db and container.</p></div> <h3 id="option-1-azure-portal"><a href="#option-1-azure-portal" class="header-anchor">#</a> Option 1: Azure Portal</h3> <h4 id="create-a-comsos-db-account"><a href="#create-a-comsos-db-account" class="header-anchor">#</a> Create a Comsos DB Account</h4> <p>In the Azure Portal, click on <em>Create Resource</em> and select <em>Azure Cosmos DB</em>. When prompted to select an API option, please choose <em>Core (SQL) - Recommended</em>.</p> <p><img src="/trainingdays/assets/img/portal_create_api_option.88c40547.png" alt="Cosmos DB API" title="Cosmos DB API options"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù As you might already know, Comsos DB supports a variety of APIs that you can use, depending on your use case. You can e.g. use the <em>MongoDB</em> API - as the <em>Cosmos DB Core API</em> - for storing documents, take the <em>Cassandra</em> API, if you have to deal with timeseries oriented data or <em>Gremlin</em>, if you want to store the data in a graph with <em>vertices</em> and <em>edges</em>. You can find out more about all the options (and when to choose which API) in the official documentation: <a href="https://docs.microsoft.com/azure/cosmos-db/choose-api" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/azure/cosmos-db/choose-api<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <p>On the wizard, please choose/enter the following parameters:</p> <table><thead><tr><th>Option Name</th> <th>Value</th></tr></thead> <tbody><tr><td><em>Resource Group</em></td> <td>Create a new resource group called <strong>rg-cosmos-challenge</strong></td></tr> <tr><td><em>Account Name</em></td> <td>Enter a globally unique account name, like <strong>azdc-cosmos-challenge</strong></td></tr> <tr><td><em>Location</em></td> <td>West Europe</td></tr> <tr><td><em>Capacity mode</em></td> <td><strong>Serverless</strong> (we use the serverless option, because it's the cheapest option for development/test purposes)</td></tr></tbody></table> <p><img src="/trainingdays/assets/img/portal_create_overview.8d5ee124.png" alt="Cosmos DB Create Wizard" title="Cosmos DB Create Wizard"></p> <p>Leave all other options as suggested by the wizard and finally click <em>Create</em>. After approximately 4-8 minutes, the database account has been created. Please go to the resource as we now need to add the database and containers for our data.</p> <h4 id="create-a-database-and-containers"><a href="#create-a-database-and-containers" class="header-anchor">#</a> Create a Database and Containers</h4> <p>The most convenient way to add a database and containers to a CosmosDB account is the <em>Data Explorer</em>. You can find the option in the context menu of the Comsos DB account overview in the Azure Portal. We now need to create two container, so please go to the <em>Data Explorer</em> and click on <em>New Container</em> in the toolbar.</p> <p><img src="/trainingdays/assets/img/portal_create_container.7472740c.png" alt="Create a new container in the data explorer" title="Create Container"></p> <h4 id="container-customer"><a href="#container-customer" class="header-anchor">#</a> Container: Customer</h4> <table><thead><tr><th>Option Name</th> <th>Value</th></tr></thead> <tbody><tr><td><em>Database id</em></td> <td>Select the option <em>Create new</em> and enter the name <em>AzDCdb</em>. With this first container, we also create the database.</td></tr> <tr><td><em>Container id</em></td> <td>customer</td></tr> <tr><td><em>Partition key</em></td> <td>/customerId</td></tr></tbody></table> <p>Click <em>Ok</em> and when the operation has finished, go to the <em>Settings</em> view of the <em>customer</em> container in the <em>Data Explorer</em> and adjust the <em>Indexing Policy</em>. Copy the following JSON document in the editor and click <em>Save</em> in the toolbar:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;indexingMode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;consistent&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;automatic&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;includedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/*&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;excludedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/title/?&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/firstName/?&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/lastName/?&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/emailAddress/?&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/phoneNumber/?&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/creationDate/?&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/addresses/*&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/\&quot;_etag\&quot;/?&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù Why are we adjusting the indexing policy? We'll come back to that point later. Just be a little bit patient.</p></div> <h4 id="container-product"><a href="#container-product" class="header-anchor">#</a> Container: Product</h4> <p>Create a <code>product</code> container similar to the one previously created. Here are the attributes:</p> <table><thead><tr><th>Option Name</th> <th>Value</th></tr></thead> <tbody><tr><td><em>Database id</em></td> <td>Select the option <em>Use existing</em> and select <em>AzDCdb</em>.</td></tr> <tr><td><em>Container id</em></td> <td>product</td></tr> <tr><td><em>Partition key</em></td> <td>/categoryId</td></tr></tbody></table> <p>For this container, there is no need to adjust the indexing policy - just leave the default settings.</p> <p>After you have created the database and the containers, the <em>Data Explorer</em> should look like that:</p> <p><img src="/trainingdays/assets/img/portal_create_container_explorer.b243a13a.png" alt="Create a new container in the data explorer" title="Create Container"></p> <p>Now we are ready to add data. You can move on to <a href="#add-and-query-data">Add and query data</a></p> <h3 id="option-2-azure-bicep"><a href="#option-2-azure-bicep" class="header-anchor">#</a> Option 2: Azure Bicep</h3> <p>You can run the following commands on your local machine or in the Azure Cloud Shell. If Azure Bicep isn't installed already, simply add it via the Azure CLI (please choose a unique name for the account and replace <code>&lt;REPLACE_WITH_ACCOUNT_NAME&gt;</code> with it):</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ az bicep <span class="token function">install</span> <span class="token comment">#only needed, if bicep isn't present in the environment</span>

$ <span class="token builtin class-name">cd</span> day3/challenges/cosmosdb

$ az group create <span class="token parameter variable">--name</span> rg-cosmos-challenge <span class="token parameter variable">--location</span> westeurope
<span class="token punctuation">{</span>
  <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rg-cosmos-challenge&quot;</span>,
  <span class="token string">&quot;location&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;westeurope&quot;</span>,
  <span class="token string">&quot;managedBy&quot;</span><span class="token builtin class-name">:</span> null,
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rg-cosmos-challenge&quot;</span>,
  <span class="token string">&quot;properties&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;provisioningState&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Succeeded&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;tags&quot;</span><span class="token builtin class-name">:</span> null,
  <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Microsoft.Resources/resourceGroups&quot;</span>
<span class="token punctuation">}</span>

$ az deployment group create <span class="token parameter variable">-f</span> cosmos.bicep <span class="token parameter variable">-g</span> rg-cosmos-challenge <span class="token parameter variable">--parameters</span> <span class="token assign-left variable">cosmosDbAccountName</span><span class="token operator">=</span><span class="token operator">&lt;</span>REPLACE_WITH_ACCOUNT_NAME<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rg-cosmos-challenge/providers/Microsoft.Resources/deployments/cosmos&quot;</span>,
  <span class="token string">&quot;location&quot;</span><span class="token builtin class-name">:</span> null,
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;cosmos&quot;</span>,
  <span class="token punctuation">..</span>.
  <span class="token punctuation">..</span>.
  <span class="token punctuation">..</span>.
  <span class="token punctuation">..</span>.
<span class="token punctuation">}</span>
</code></pre></div><p>After approximately 8-10 minutes, the Cosmos DB account, database and the containers (<em>product</em> and <em>customer</em>) have been created and are ready to be used. Open the account in the Azure Portal and navigate to the <em>Data Explorer</em>. It should look like similar to that:</p> <p><img src="/trainingdays/assets/img/portal_create_container_explorer.b243a13a.png" alt="Create a new container in the data explorer" title="Create Container"></p> <p>Let's add data to the two containers.</p> <h2 id="add-and-query-data"><a href="#add-and-query-data" class="header-anchor">#</a> Add and query data</h2> <p>Now, it's time to add data to the <em>customer</em> and <em>product</em> containers. There a two datasets that have been prepared for you.</p> <h3 id="customer-dataset"><a href="#customer-dataset" class="header-anchor">#</a> Customer Dataset</h3> <p>The <em>customer</em> dataset contains of two types of objects that we put in the same container: <strong>customer</strong> and <strong>salesOrder</strong>. Wait...two object types in the same container? You learned that when dealing with data in a (relational) database, the data should always be normalized and that it's best to have one object type in one table! &quot;This is totally against that principle&quot;, you might think.</p> <p>Yes, you are right - in a relational environment. But here, we are working with a NoSQL database and things are a little bit different. Mixing object types in one container is totally fine (and even a best practice in terms of performance). In this non-relational world, you also tend to follow the &quot;de-normalization&quot; principle. That means that data duplication, embedding etc. is not only possible, but encouraged. You optimize data models to make sure that all the required data is ready to be served by queries.</p> <h4 id="customer-data"><a href="#customer-data" class="header-anchor">#</a> Customer Data</h4> <p>Sample object from the container:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;customerId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;firstName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Franklin&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lastName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Ye&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;emailAddress&quot;</span><span class="token operator">:</span> <span class="token string">&quot;franklin9@adventure-works.com&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;phoneNumber&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1 (11) 500 555-0139&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;creationDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2014-02-05T00:00:00&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;addresses&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;addressLine1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1796 Westbury Dr.&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;addressLine2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;city&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Melton&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VIC&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;country&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AU&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;zipCode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3337&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;hash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;GQF7qjEgMl3LUppoPfDDnPtHp1tXmhQBw0GboOjB8bk=&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;salt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;12C0F5A5&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;salesOrderCount&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre></div><p>A customer document has a property <code>type</code> set to <em>customer</em> and contains several properties like <code>firstName</code>, <code>lastName</code>, <code>emailAddress</code> etc. You can see, that it also uses document embedding for <code>addresses</code> - the property is an array, so you can add multiple addresses to one customer.</p> <div class="custom-block tip"><p class="custom-block-title">When to use embedding? When to use referencing?</p> <p>üìù To model relations in a document-oriented database, you have two choices: embedding and referencing. But which should you choose when?</p> <table><thead><tr><th>Embedding</th> <th>Referencing</th></tr></thead> <tbody><tr><td>1:1 relationship</td> <td>1:many relationship (especially if unbounded)</td></tr> <tr><td>1:few relationship</td> <td>Many:many relationship</td></tr> <tr><td>Related items are queried or updated together</td> <td>Related items are queried or updated independently</td></tr></tbody></table></div> <p>The partition key of the container has been set to <code>/customerId</code>, so each customer is placed in its own logical partition. With that approach, we achive the best distribution of data in terms of horizontal scaling and will never hit any storage limits - so we are prepared for massive growth of the data/application. On the other hand, this is not the best way when we want to search within our customer base, because we will definitely have cross-partition queries and they will consume more and more RUs as the data grows. How to deal with such a situation is discussed later in the challenge.</p> <h4 id="salesorder-data"><a href="#salesorder-data" class="header-anchor">#</a> SalesOrder Data</h4> <p>Sample object from the container:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;091F884C-DC00-4422-9B89-3438B22DEF07&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;salesOrder&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;customerId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;orderDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2014-03-03T00:00:00&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;shipDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2014-03-10T00:00:00&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;details&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;sku&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TT-M928&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Mountain Tire Tube&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">4.99</span><span class="token punctuation">,</span>
        <span class="token property">&quot;quantity&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;sku&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PK-7098&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Patch Kit/8 Patches&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">2.29</span><span class="token punctuation">,</span>
        <span class="token property">&quot;quantity&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;sku&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TI-M267&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;LL Mountain Tire&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">24.99</span><span class="token punctuation">,</span>
        <span class="token property">&quot;quantity&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The salesorder object is similar to the customer object (<code>type</code> is set to <em>salesOrder</em>). It has properties that you would expect for a sales order like <code>orderDate</code>, <code>shipDate</code>, <code>customerId</code> etc. Also, embedding is used to save the line items of the order.</p> <p>As these objects are stored in the same collection as the customers (<code>customer</code> collection), the partition key is also set to <code>customerId</code>. This has a huge advantage over storing the sales orders in a separate collection: you can query both customer and the corresponding sales orders in one query - and all items queried lie in the same logical thus physical partition. Queries are super fast and - from a relational standpoint - you avoid costly JOINs over several tables or multiple queries at all.</p> <p><a href="https://github.com/azuredevcollege/trainingdays/tree/master/day3/challenges/fixtures/" target="_blank" rel="noopener noreferrer">Download the whole customer dataset here.<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="product-dataset"><a href="#product-dataset" class="header-anchor">#</a> Product Dataset</h3> <p>The product dataset contains just one object type: <code>product</code>. It simply stores the information for each product like <code>name</code>, <code>price</code>, <code>categoryName</code>. The collection is partitioned by <code>/categoryId</code>, so products are logically grouped by and can be queried via category.</p> <h4 id="product-data"><a href="#product-data" class="header-anchor">#</a> Product Data</h4> <p>Here's a sample object from the container:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;9190229B-1372-4997-8F64-5B3E7A2459C5&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;categoryId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;86F3CBAB-97A7-4D01-BABB-ADEFFFAED6B4&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;categoryName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Accessories, Tires and Tubes&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sku&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TT-M928&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Mountain Tire Tube&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The product called \&quot;Mountain Tire Tube\&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">4.99</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;66D8EA21-E1F0-471C-A17F-02F3B149D6E6&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Tag-83&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6FB11EB9-319C-431C-89D7-70113401D186&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Tag-154&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8AAFD985-8BCE-4FA8-85A2-2CA67D9DF8E6&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Tag-172&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;A4D9E596-B630-4792-BDD1-7D6459827820&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Tag-164&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://github.com/azuredevcollege/trainingdays/tree/master/day3/challenges/fixtures/cosmosdb/product.json" target="_blank" rel="noopener noreferrer">Download the product dataset here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="upload-the-datasets"><a href="#upload-the-datasets" class="header-anchor">#</a> Upload the datasets</h3> <p>To add the datasets to Cosmos DB, go to the <em>Data Explorer</em> and first open the <em>Items</em> menu item of the <em>customer</em> container. When the tab appears, you'll see an <em>Upload Item</em> button in the toolbar. Click on that button, then select the <em>customer.json</em> file that you previously downloaded and click <em>Upload</em>.</p> <p><img src="/trainingdays/assets/img/portal_dataexplorer_upload.e84edfb3.png" alt="Upload data to a container in the data explorer" title="Upload data"></p> <p>Do the same with the <em>product.json</em> file for the <em>product</em> collection.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù Depending on your network speed and latency, the uploads should take about 2-4 minutes.</p></div> <h3 id="queries"><a href="#queries" class="header-anchor">#</a> Queries</h3> <p>Let's work with the data and execute some queries against the two containers.</p> <h4 id="simple-queries"><a href="#simple-queries" class="header-anchor">#</a> Simple queries</h4> <p>First, let's issue queries in the <em>customer</em> container where we have customer and sales order objects. Let's start with a few simple queries.</p> <p>Therefor, go to the Data Explorer, open the <em>Items</em> menu item of the <em>customer</em> container and click on <em>New SQL Query</em> in the toolbar.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù You can open the <em>Data Explorer</em> as a separate window via the toolbar.</p></div> <p><img src="/trainingdays/assets/img/portal_dataexplorer_newquery.528b80a0.png" alt="Create new SQL query in Data Explorer" title="New SQL Query"></p> <p>In the newly created tab, enter the following SQL command and click <em>Execute</em>.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c
</code></pre></div><p>As you can see in the <em>Results</em> tab, Cosmos DB returns a set of documents, that live in the <em>customer</em> container. It returns a paged resultset, showing documents in batches of 100 items.</p> <p><img src="/trainingdays/assets/img/portal_dataexplorer_results.5885c78f.png" alt="Results of a SQL query in Data Explorer" title="SQL Query resultset"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù Have a look at the <em>Query Stats</em> tab! Here you can see what amount of RUs have been consumed by the query (and also other statistics).</p></div> <p>As you can see in the result document, there is a bunch of properties, that have a special meaning for documents stored via the SQL API, e.g. <em>id</em>, _<em>rid</em>, _<em>ts</em> etc. All properties are described in the following table (excerpt from the official Comsos DB documentation):</p> <table><thead><tr><th>Property</th> <th>Description</th></tr></thead> <tbody><tr><td><em>id</em></td> <td>Required. It is a user settable property. It is the unique attribute that identifies the document, that is, no two documents share the same ID <strong>within a logical partition</strong>. Partition and ID uniquely identifies an item in the database. The id field must not exceed 255 characters.</td></tr> <tr><td>_<em>rid</em></td> <td>It is a system generated property. The resource ID (_rid) is a unique identifier that is also hierarchical per the resource stack on the resource model. It is used internally for placement and navigation of the document resource.</td></tr> <tr><td>_<em>ts</em></td> <td>It is a system generated property. It specifies the last updated timestamp of the resource. The value is a timestamp.</td></tr> <tr><td>_<em>self</em></td> <td>It is a system generated property. It is the unique addressable URI for the resource.</td></tr> <tr><td>_<em>etag</em></td> <td>It is a system generated property that specifies the resource etag required for <a href="https://docs.microsoft.com/azure/cosmos-db/database-transactions-optimistic-concurrency#optimistic-concurrency-control" target="_blank" rel="noopener noreferrer">optimistic concurrency control<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</td></tr> <tr><td>_<em>attachments</em></td> <td>It is a system generated property that specifies the addressable path for the attachments resource.</td></tr> <tr><td><em>ttl</em></td> <td>Azure Cosmos DB provides the ability to delete items automatically from a container after a certain time period. By default, you can set <em>time to live</em> or <em>TTL</em> at the container level and override the value on a per-item basis. Use the <em>ttl</em> property for setting the per-item time period. More on that <a href="https://docs.microsoft.com/azure/cosmos-db/time-to-live" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</td></tr></tbody></table> <p>Let's execute another query to determine the amount of documents stored in the <em>customer</em> collection.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> numDocuments <span class="token keyword">FROM</span> c
</code></pre></div><p>The result should produce a JSON document like this:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">&quot;numDocuments&quot;</span><span class="token operator">:</span> <span class="token number">50584</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>You can also query the value directly by adding the <code>VALUE</code> keyword:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">VALUE</span><span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> c
</code></pre></div><p>Result:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token number">50584</span>
<span class="token punctuation">]</span>
</code></pre></div><h4 id="indexing-and-partition-aware-queries"><a href="#indexing-and-partition-aware-queries" class="header-anchor">#</a> Indexing and Partition-Aware Queries</h4> <p>In Azure Cosmos DB, documents are automatically indexed without having to define a schema or create any secondary indexes. Every document that is stored in Cosmos DB is converted to a tree object, so that you can reference each property via its path.</p> <p><img src="/trainingdays/assets/img/document_tree.af75dc1b.png" alt="Tree respresentation in Cosmos DB" title="Propery tree"></p> <p>E.g., you can access the <em>city</em> property of the first address of a customer object via <code>/addresses/0/city</code>.</p> <p>Adding an index can significantly reduce the query time and consumed RUs, but can also be expensive when adding or updating a document, because after each action, the index has to be recalculated/recreated for the document data. So, if you have write-intensive workloads, it is better to tweak the indexing policy.</p> <p>Let's have a look at the <em>customer</em> document. The indexing policy has been adjusted to NOT(!) index fields like <em>firstName</em>, <em>title</em>, <em>addresses</em> etc. Adding or updating a customer consumes ~ 8.5 RUs. Using the standard indexing policy (which means all properties will be indexed), the same operation consumes ~13.2 RUs. That's about 150% &quot;the price&quot;.</p> <div class="custom-block tip"><p class="custom-block-title">Index Types</p> <p>üìù Cosmos DB supports several index types like <em>range</em>, <em>spatial</em> (for geo-data) and <em>composite indexes</em>. To learn more about when to use what kind of index, refer to the official documentation: <a href="https://docs.microsoft.com/azure/cosmos-db/index-overview" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/azure/cosmos-db/index-overview<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <p>You saw that limiting the amount of properties that get indexed is beneficial for storing data. RU cost is significantly reduced. But it has impact on querying data. If you want to use the collection to give users of your application to search and query for any properties, it has the opposite impact. A lot of RUs will be consumed.</p> <p>Let's demonstrate that. Open a new query tab for the <em>customer</em> container, issue the following queries and have a look at the <em>Query Stats</em> tab to see the amount of RUs consumed.</p> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">&quot;Franklin&quot;</span>
</code></pre></div><p>The problem here is, that we are querying for a property that is not indexed <strong>and</strong> the query itself is a <em>cross-partition</em> query. Azure Cosmos DB needs to fan-out the query to all physical partitions of the database. If you have a lot of data in the collection (e.g. 100GB), the cost for such a query will be a lot more expensive, because the amount of physical partitions will grow depending on how much data is stored in a container and thus the number of queries that need to be managed under the hood by the db engine.</p> <p>Let's add the partition key to the query (means: Cosmos DB knows exactly to which physical partition to send the query to.).</p> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">&quot;Franklin&quot;</span> 
    <span class="token operator">AND</span> c<span class="token punctuation">.</span>customerId <span class="token operator">=</span> <span class="token string">&quot;0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161&quot;</span>
</code></pre></div><p>This is <em>much</em> better! Now, let's adjust the indexing policy so that all properties will be indexed. Go to the <em>Scale &amp; Settings</em> menu item of the <em>customer</em> container and set the indexing policy to:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;indexingMode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;consistent&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;automatic&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;includedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/*&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;excludedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/\&quot;_etag\&quot;/?&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Comsos DB needs a few minutes to index the container - now for a query intensive application. Exceute the queries again and have another look at the <em>Query Stats</em>. You'll see a huge improvement in terms of RU cost.</p> <p>Cross-partition:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">&quot;Franklin&quot;</span>
</code></pre></div><p>With partition key:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">&quot;Franklin&quot;</span> 
    <span class="token operator">AND</span> c<span class="token punctuation">.</span>customerId <span class="token operator">=</span> <span class="token string">&quot;0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161&quot;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù You can see, even cross-partition queries profit from proper indexing when executing queries. Nevertheless, you should definitely avoid these kind of queries as the cost grows with the amount of data stored in a container.</p></div> <h4 id="can-i-do-relational-joins"><a href="#can-i-do-relational-joins" class="header-anchor">#</a> Can I do (relational) JOINs?</h4> <p>One of the most discussed topics is how to model relations in Cosmos DB. You already saw one technique how to query related data: embedding. With embedding, you simply add the related data to the document as shown in the <em>customer</em> object with <em>addresses</em>. When you read a customer document, addresses will automatically be fetched as well, because the information is part of the object itself.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;customerId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161&quot;</span><span class="token punctuation">,</span>
    ...
    ...
    <span class="token property">&quot;creationDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2014-02-05T00:00:00&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;addresses&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;addressLine1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1796 Westbury Dr.&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;addressLine2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;city&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Melton&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VIC&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;country&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AU&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;zipCode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3337&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This is a good practice, if you have 1:few relationships. If you have unbounded collections/relations, this is considered an anti-pattern, because storing and querying such a document is becoming expensive (also consider: you have an upper limit regarding the document size, which is currently set to <em>2MB</em>.).</p> <p>Another technqiue is to place the related data in the same container, with the same partion key, so that you can query all data at once with a single command. Since all objects are placed in the same logical partition, commands consume the least amount of RUs possible and perform very well.</p> <h5 id="example"><a href="#example" class="header-anchor">#</a> Example</h5> <p>Consider having customers and order objects in your application, that are placed in <strong>separate containers</strong>. To query a specific customer and all related orders, you would first issue a query that gets the customer and a second query that retrieves all order objects. In a relational database, you would just use one SQL query with a JOIN statement over these two tables.</p> <p>In Comsos DB, just put the objects in the same container and with the same partition key and fetch both object types with one single query. No need to have costly JOINs or multiple select statements.</p> <p>The current sample dataset <code>customer</code> is designed like that, so let's query for those objects.</p> <h5 id="query-for-a-customer-object"><a href="#query-for-a-customer-object" class="header-anchor">#</a> Query for a customer object</h5> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>customerId <span class="token operator">=</span> <span class="token string">&quot;0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161&quot;</span> 
  <span class="token operator">AND</span> c<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">&quot;customer&quot;</span>
</code></pre></div><h5 id="query-for-the-sales-orders-of-that-customer"><a href="#query-for-the-sales-orders-of-that-customer" class="header-anchor">#</a> Query for the sales orders of that customer</h5> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>customerId <span class="token operator">=</span> <span class="token string">&quot;0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161&quot;</span> 
  <span class="token operator">AND</span> c<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">&quot;salesOrder&quot;</span>
</code></pre></div><h5 id="query-for-the-customer-as-well-as-for-the-sales-orders-in-one-statement"><a href="#query-for-the-customer-as-well-as-for-the-sales-orders-in-one-statement" class="header-anchor">#</a> Query for the customer, as well as for the sales orders in one statement</h5> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>customerId <span class="token operator">=</span> <span class="token string">&quot;0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161&quot;</span>
</code></pre></div><p>As you can see in the query stats: it's fast and cheap in terms of RUs cost.</p> <h4 id="aggerations-functions-etc"><a href="#aggerations-functions-etc" class="header-anchor">#</a> Aggerations, Functions etc</h4> <p>Of course, Cosmos DB also supports aggregations, functions, geo-spatial data handling, triggers, subqueries, and much more. To give you an impression, what is possible, here are a few queries you can try on the <em>product</em> and <em>customer</em> container.</p> <h5 id="get-the-average-price-of-products-by-category"><a href="#get-the-average-price-of-products-by-category" class="header-anchor">#</a> Get the average price of products by category</h5> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> c<span class="token punctuation">.</span>categoryName <span class="token keyword">as</span> Category<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> avgPrice <span class="token keyword">FROM</span> c <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>categoryName
</code></pre></div><h5 id="get-the-average-price-of-products-by-category-within-a-category"><a href="#get-the-average-price-of-products-by-category-within-a-category" class="header-anchor">#</a> Get the average price of products by category - within a category</h5> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> c<span class="token punctuation">.</span>categoryName <span class="token keyword">as</span> Category<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> avgPrice <span class="token keyword">FROM</span> c 
    <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>categoryId <span class="token operator">=</span> <span class="token string">&quot;75BF1ACB-168D-469C-9AA3-1FD26BB4EA4C&quot;</span> 
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>categoryName
</code></pre></div><h5 id="get-the-top-10-customers-by-orders-customer-container"><a href="#get-the-top-10-customers-by-orders-customer-container" class="header-anchor">#</a> Get the top 10 customers by orders - <em>customer</em> container</h5> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">10</span> c<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> c<span class="token punctuation">.</span>lastName<span class="token punctuation">,</span> c<span class="token punctuation">.</span>salesOrderCount <span class="token keyword">FROM</span> c
    <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'customer'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>salesOrderCount <span class="token keyword">DESC</span>
</code></pre></div><h2 id="use-the-cosmos-db-change-feed"><a href="#use-the-cosmos-db-change-feed" class="header-anchor">#</a> Use the Cosmos DB Change Feed</h2> <h3 id="why-to-use-it"><a href="#why-to-use-it" class="header-anchor">#</a> Why to use it?</h3> <p>The Azure Cosmos DB change feed enables efficient processing of large datasets with a high volume of writes. The change feed also offers an alternative to querying an entire dataset to identify what has changed. This section focuses on giving an overview of the Cosmos DB change feed, how to consume it and a sample where an Azure Function consumes the message from the change feed.</p> <p>Azure Cosmos DB is a service that is well-suited for streaming applications like IoT, gaming, but also retail and operational logging applications. It is often used in microservices-based application due to the features it offers with the change feed. A common design pattern in all these applications is to use changes to the data to trigger additional actions. Examples of additional actions include:</p> <ul><li>Triggering a notification or a call to an API, when an item is inserted or updated.</li> <li>Real-time stream processing for IoT or real-time analytics processing on operational data.</li> <li>Data movement such as synchronizing with a cache, a search engine, a data
warehouse, or cold storage.</li></ul> <p>The change feed in Azure Cosmos DB enables you to build efficient and scalable solutions for each of these patterns, as shown in the following image:</p> <p><img src="/trainingdays/assets/img/changefeedoverview.f37a73b3.png" alt="Overview of event processing using Azure Cosmos DB Change Feed" title="Event Processing with Comsos DB"></p> <p>For event processing and notifications the Azure Cosmos DB change feed can simplify scenarios that need to trigger a notification or send a call to an API based on a certain event.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù Reagarding some patterns and best practices for change feed, you can read more details <a href="https://docs.microsoft.com/azure/cosmos-db/change-feed-design-patterns" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <h3 id="what-does-it-support"><a href="#what-does-it-support" class="header-anchor">#</a> What does it support?</h3> <p>The following APIs are supported:</p> <ul><li>SQL API</li> <li>MongoDB API</li> <li>Cassandra API</li> <li>Gremlin API</li></ul> <p>What's not supported:</p> <ul><li>Table API</li></ul> <h3 id="how-to-consume-the-change-feed"><a href="#how-to-consume-the-change-feed" class="header-anchor">#</a> How to consume the Change Feed?</h3> <p>In this challenge we will use an Azure Function hence providing the simplest way to connect to the change feed. You can create small reactive Azure Function that will be automatically triggered on each new event in your Azure Cosmos
container's change feed.</p> <p>As this is an introduction, we will focus on the Azure Function sample. If you are interested to read about other options like the ChangeFeed Processor, you can get more details <a href="https://docs.microsoft.com/azure/cosmos-db/change-feed-processor" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p><img src="/trainingdays/assets/img/functions.d5a047bf.png" alt="Azure Function processing events from the Change Feed" title="Change Feed Overview"></p> <p>With the change feed feature, you get a consistent, in-order stream of changes within the logical partitions of your container.</p> <p><img src="/trainingdays/assets/img/changefeedvisual.216222cf.png" alt="Overview Change Feed with multiple consumers" title="Customer Container Change Feed"></p> <h3 id="sample-create-a-customerview-collection-for-query-optimized-access-to-customer-data"><a href="#sample-create-a-customerview-collection-for-query-optimized-access-to-customer-data" class="header-anchor">#</a> Sample: Create a customerView collection for query-optimized access to Customer data</h3> <p>Let's assume the following scenario: Your application is used to query for customers based on the country the customer is located. Your sales colleagues are organized in sales areas (countries), so it's a valid scenario for them. Unfortunately, the <code>customer</code> container is not prepared for such queries, because these queries would result in cross-partition statements. As we learned, this will effect the performance and cost of our <code>customer</code> container. In the following sample we will create an item in the <code>customer</code> container which is triggering a message to the change feed consumer - in this case an Azure Function. The consumer replicates the item from the change feed to another container called <code>customerView</code> which is partitioned by the country (<code>/area</code>) and is therefor optimized for the queries of the sales colleagues.</p> <p>You have two options to deploy the collection: either via the Azure Portal or via a <em>bicep</em> template.</p> <h4 id="option-1-deployment-via-portal"><a href="#option-1-deployment-via-portal" class="header-anchor">#</a> Option 1: Deployment via Portal</h4> <p>See the description of how to deploy a Cosmos DB via Portal from above or use the existing one.
Create a collection <code>customerView</code> using as partition key <code>/area</code>.</p> <table><thead><tr><th>Option Name</th> <th>Value</th></tr></thead> <tbody><tr><td><em>Database id</em></td> <td>Select the option <em>Use existing</em> and select <em>AzDCdb</em>.</td></tr> <tr><td><em>Container id</em></td> <td>customerView</td></tr> <tr><td><em>Partition key</em></td> <td>/area</td></tr></tbody></table> <h4 id="option-2-deployment-via-bicep-file"><a href="#option-2-deployment-via-bicep-file" class="header-anchor">#</a> Option 2: Deployment via Bicep File</h4> <p>There is a bicep file prepared for you in the <code>cosmosdb</code> folder which lets you automatically deploy the Cosmos DB <code>customerView</code> container to the existing Cosmos DB Account.</p> <p>Go ahead and open up a commandline window and use the following command:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> trainingdays/day3/challenges/cosmosdb
az deployment group create <span class="token parameter variable">-g</span> rg-cosmos-challenge --template-file addcustomerviewcontainer.bicep <span class="token parameter variable">--parameters</span> <span class="token assign-left variable">cosmosDbAccountName</span><span class="token operator">=</span><span class="token operator">&lt;</span>REPLACE_WITH_ACCOUNT_NAME<span class="token operator">&gt;</span>
</code></pre></div><h4 id="purpose-of-the-azure-function"><a href="#purpose-of-the-azure-function" class="header-anchor">#</a> Purpose of the Azure Function</h4> <p>The function listens to every change on the <code>customer</code> collection and pushes customer documents that have <code>Germany / DE</code> or <code>France / FR</code> as country code in their address to the <code>customerView</code> collection. Go ahead and open up your Visual Studio Code in the function folder using the following folder path:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> trainingdays/day3/challenges/cosmosdb/func
code <span class="token builtin class-name">.</span>
</code></pre></div><p>Create a file called <code>local.settings.json</code> in the folder <em>day3/challenges/cosmosdb/func</em> with the following content and adjust the connection string to the CosmosDB account. Also, create a storage account in the Azure Portal and replace the storage account connection string in the settings file:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;IsEncrypted&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;Values&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;AzureWebJobsStorage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;ADD STORAGE ACCOUNT CONNECTION STRING&gt;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;FUNCTIONS_WORKER_RUNTIME&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;myDB_DOCUMENTDB&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;ADD COSMOSDB CONNECTION STRING&gt;&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>When created, take a look at the <code>function.json</code> file in the <em>CosmosTrigger1</em> folder. We set the <code>StartFromBeginning</code> CosmosDBTrigger attribute in the <code>function.json</code> to true:</p> <div class="language-json extra-class"><pre class="language-json"><code>startFromBeginning&quot;<span class="token operator">:</span> <span class="token boolean">true</span>
</code></pre></div><p>This setting tells the function to read the change feed entries <strong>from the beginning</strong> and not just from the point in time where it connects to the change feed - this gives you access to the history of your collection. Running the function, will read and process all changes from the beginning of the change feed.</p> <p>Now, open up the <code>index.js</code> file and set a break point next to line 6:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>val<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">'customer'</span> <span class="token operator">&amp;&amp;</span>
</code></pre></div><p>Let's move on and start the function using the debug mode in VS Code. You will see the function process all entries in the change feed in batches of 100 documents. As you can see in the <code>index.js</code> file, we only take care of entries where the address is in France or Germany (just to speed things a little bit up).</p> <p>When the processing has finished, take a look at the <code>customerView</code> collection. You'll see all customers that are located in Germany and France.</p> <p>To prove that this process works near real-time, let's go to the portal and insert a new <em>item</em> into the <code>customer</code> container (if you want to, set a breakpoint again to see the change arriving at your function):</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;034C5E4C-EE20-47E2-8637-5CCB02525EDE&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;customerId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;034C5E4C-EE20-47E2-8637-5CCB02525EDE&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;firstName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Jackson&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lastName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Frieda&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;emailAddress&quot;</span><span class="token operator">:</span> <span class="token string">&quot;f.jackson@adventure-works.com&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;phoneNumber&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1 (11) 500 555-0121&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;creationDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2013-04-12T00:00:00&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;addresses&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;addressLine1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Roemerplatz 90&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;addressLine2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;city&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Remchingen&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;BW&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;country&quot;</span><span class="token operator">:</span> <span class="token string">&quot;DE&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;zipCode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;75196&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;hash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ruT19z16403NBEe2S1WlSaA3dUmC4chHgTemAJMU6E4=&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;salt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;C554EA68&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;salesOrderCount&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre></div><p>After saving, it should look like this:</p> <p><img src="/trainingdays/assets/img/portal_create_customer.b1a9c666.png" alt="Create a customer item" title="Create Customer"></p> <p>Once the item has been created, the Azure Function gets triggered:</p> <p><img src="/trainingdays/assets/img/breakpointchangefeed.e0a508be.png" alt="Set a breakpoint in VS Code" title="Breakpoint in VS Code"></p> <p>As final result we will see the customer - as the country code matches Germany (DE) - in the <code>customerView</code> Container:</p> <p><img src="/trainingdays/assets/img/portal_customerview_result.44db7b99.png" alt="CustomerView collection with result" title="customerView collection"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù When using an Azure Function to connect to the Cosmos DB change feed, you'll see a <code>leases</code> container appear in your database. This is used to track the progress of the Azure Function when processing the feed.</p></div> <h3 id="what-have-we-learned-so-far"><a href="#what-have-we-learned-so-far" class="header-anchor">#</a> What have we learned so far?</h3> <p>We learned about the change feed, when to use it and what APIs are supported. Further Azure Function bindings are a simple way to track the changes which occurred in the CosmosDB. And in the hands-on part, we also added a <code>customerView</code> container via Portal or via bicep file. In addition we ran the Azure Function code (locally) to listen to every change on the <code>customer</code> collection where we added a German customer item and replicated the item to the <code>customerView</code> collection for query-optimized access.</p> <h4 id="optional"><a href="#optional" class="header-anchor">#</a> Optional</h4> <p>If you want to do more, you can deploy the bicep file <em>function.bicep</em> using this command and use <em>Day 2</em> as your <em>cheat sheet</em> of how to deploy the code towards the Azure Function service.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az deployment group create <span class="token parameter variable">-g</span> rg-cosmos-challenge --template-file function.bicep
</code></pre></div><p>For using Cosmos DB in production monitoring is essential, which will be focused on in the next section.</p> <h2 id="monitor-cosmos-db"><a href="#monitor-cosmos-db" class="header-anchor">#</a> Monitor Cosmos DB</h2> <p>In order to monitor your CosmosDB account, the databases and collections for performance, failures, throtteling, operational health etc. the <em>CosmosDB Insights</em> workbook is your friend.</p> <p>You can access the dashboards in the CosmosDB account view and click on <em>Insights</em> in the context menu under &quot;Monitoring&quot;.</p> <p>Here are a few sample dashboards that help you understand what's going on in your Cosmos DB account.</p> <p>When you have successfully finished the Change Feed challenge, you should see metrics like the following ones:</p> <p><img src="/trainingdays/assets/img/portal_insights1.441112c5.png" alt="Monitoring Insights in Azure Portal" title="Portal Insights 1"> <img src="/trainingdays/assets/img/portal_insights2.8da090cf.png" alt="Monitoring Insights in Azure Portal" title="Portal Insights 2"> <img src="/trainingdays/assets/img/portal_insights3.f6f01cc5.png" alt="Monitoring Insights in Azure Portal" title="Portal Insights 3"></p> <h2 id="azure-samples-further-information"><a href="#azure-samples-further-information" class="header-anchor">#</a> Azure Samples / Further Information</h2> <ul><li><a href="https://docs.microsoft.com/azure/cosmos-db/modeling-data" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/azure/cosmos-db/modeling-data<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - Modelling data</li> <li><a href="https://docs.microsoft.com/azure/cosmos-db/sql-query-getting-started" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/azure/cosmos-db/sql-query-getting-started<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - SQL API Queries</li> <li><a href="https://aka.ms/PracticalCosmosDB" target="_blank" rel="noopener noreferrer">https://aka.ms/PracticalCosmosDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - model a blog platform</li> <li><a href="https://youtube.com/azurecosmosdb" target="_blank" rel="noopener noreferrer">https://youtube.com/azurecosmosdb<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - videos on CosmosDB</li> <li><a href="https://devblogs.microsoft.com/cosmosdb/" target="_blank" rel="noopener noreferrer">https://devblogs.microsoft.com/cosmosdb/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - official CosmosDB blog</li> <li><a href="https://docs.microsoft.com/azure/cosmos-db/concepts-limits" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/azure/cosmos-db/concepts-limits<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - Service limits</li></ul> <h2 id="cleanup"><a href="#cleanup" class="header-anchor">#</a> Cleanup</h2> <p>No clean-up needed this time. We will reuse the Cosmos DB account in the Azure
Cognitive Search challenge. So please, <strong>don't delete any of the resources yet</strong>.</p> <p><a href="/trainingdays/day3/challenges/00-challenge-baseline.html">‚óÄ Previous challenge</a> | <a href="/trainingdays/day3/" class="router-link-active">üîº Day 3</a> | <a href="/trainingdays/day3/challenges/02-challenge-sql.html">Next challenge ‚ñ∂</a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azuredevcollege/trainingdays/edit/master/day3/challenges/01-challenge-cosmosdb.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/trainingdays/assets/js/app.e8a6fdbf.js" defer></script><script src="/trainingdays/assets/js/3.9b3cf7d1.js" defer></script><script src="/trainingdays/assets/js/6.49058ca4.js" defer></script>
  </body>
</html>
