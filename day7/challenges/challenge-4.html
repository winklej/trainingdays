<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Challenge 4: Deploy a Microservice-Oriented Sample Application | Azure Developer College</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/trainingdays/assets/css/0.styles.8d7a09fd.css" as="style"><link rel="preload" href="/trainingdays/assets/js/app.e8a6fdbf.js" as="script"><link rel="preload" href="/trainingdays/assets/js/3.9b3cf7d1.js" as="script"><link rel="preload" href="/trainingdays/assets/js/15.74de6942.js" as="script"><link rel="prefetch" href="/trainingdays/assets/js/10.5e63eee4.js"><link rel="prefetch" href="/trainingdays/assets/js/11.52cdb15c.js"><link rel="prefetch" href="/trainingdays/assets/js/12.dd68cce1.js"><link rel="prefetch" href="/trainingdays/assets/js/13.968f15e4.js"><link rel="prefetch" href="/trainingdays/assets/js/14.6107e61f.js"><link rel="prefetch" href="/trainingdays/assets/js/16.bf550880.js"><link rel="prefetch" href="/trainingdays/assets/js/17.25c2442d.js"><link rel="prefetch" href="/trainingdays/assets/js/18.df448a3a.js"><link rel="prefetch" href="/trainingdays/assets/js/19.57fc59b2.js"><link rel="prefetch" href="/trainingdays/assets/js/2.5f4f93ed.js"><link rel="prefetch" href="/trainingdays/assets/js/20.b16a4364.js"><link rel="prefetch" href="/trainingdays/assets/js/21.f120af84.js"><link rel="prefetch" href="/trainingdays/assets/js/22.a29f663d.js"><link rel="prefetch" href="/trainingdays/assets/js/23.2e9fa4d5.js"><link rel="prefetch" href="/trainingdays/assets/js/24.df3c97d4.js"><link rel="prefetch" href="/trainingdays/assets/js/25.d7157d1b.js"><link rel="prefetch" href="/trainingdays/assets/js/26.8b935eca.js"><link rel="prefetch" href="/trainingdays/assets/js/27.fab398a7.js"><link rel="prefetch" href="/trainingdays/assets/js/28.f45e3c7c.js"><link rel="prefetch" href="/trainingdays/assets/js/29.1ebc26ec.js"><link rel="prefetch" href="/trainingdays/assets/js/30.6728cb2f.js"><link rel="prefetch" href="/trainingdays/assets/js/31.0447b951.js"><link rel="prefetch" href="/trainingdays/assets/js/32.7ba3de54.js"><link rel="prefetch" href="/trainingdays/assets/js/33.1886053c.js"><link rel="prefetch" href="/trainingdays/assets/js/34.71397a5c.js"><link rel="prefetch" href="/trainingdays/assets/js/35.3f4903ee.js"><link rel="prefetch" href="/trainingdays/assets/js/36.ca5c6cd3.js"><link rel="prefetch" href="/trainingdays/assets/js/37.150f3aea.js"><link rel="prefetch" href="/trainingdays/assets/js/38.267b0401.js"><link rel="prefetch" href="/trainingdays/assets/js/39.b63e5745.js"><link rel="prefetch" href="/trainingdays/assets/js/4.51ff6f02.js"><link rel="prefetch" href="/trainingdays/assets/js/40.ccce5e2d.js"><link rel="prefetch" href="/trainingdays/assets/js/41.8d1a41f2.js"><link rel="prefetch" href="/trainingdays/assets/js/42.b2565944.js"><link rel="prefetch" href="/trainingdays/assets/js/43.b9bb36ce.js"><link rel="prefetch" href="/trainingdays/assets/js/44.0cb215c3.js"><link rel="prefetch" href="/trainingdays/assets/js/45.ed0b28e2.js"><link rel="prefetch" href="/trainingdays/assets/js/46.d7dc415d.js"><link rel="prefetch" href="/trainingdays/assets/js/47.94e659f8.js"><link rel="prefetch" href="/trainingdays/assets/js/48.22da67bb.js"><link rel="prefetch" href="/trainingdays/assets/js/49.d0cc21bd.js"><link rel="prefetch" href="/trainingdays/assets/js/5.8a1a1dd9.js"><link rel="prefetch" href="/trainingdays/assets/js/50.fc76ce90.js"><link rel="prefetch" href="/trainingdays/assets/js/51.49e6933d.js"><link rel="prefetch" href="/trainingdays/assets/js/52.b3007d12.js"><link rel="prefetch" href="/trainingdays/assets/js/53.ce74ac77.js"><link rel="prefetch" href="/trainingdays/assets/js/54.0ae1433b.js"><link rel="prefetch" href="/trainingdays/assets/js/55.84f6f655.js"><link rel="prefetch" href="/trainingdays/assets/js/56.8abf9a8b.js"><link rel="prefetch" href="/trainingdays/assets/js/57.5f879cc0.js"><link rel="prefetch" href="/trainingdays/assets/js/58.143be8bb.js"><link rel="prefetch" href="/trainingdays/assets/js/59.48d8acfe.js"><link rel="prefetch" href="/trainingdays/assets/js/6.49058ca4.js"><link rel="prefetch" href="/trainingdays/assets/js/60.a173b602.js"><link rel="prefetch" href="/trainingdays/assets/js/61.04f45b6d.js"><link rel="prefetch" href="/trainingdays/assets/js/62.c3ecf647.js"><link rel="prefetch" href="/trainingdays/assets/js/63.ad717965.js"><link rel="prefetch" href="/trainingdays/assets/js/64.3e451a8e.js"><link rel="prefetch" href="/trainingdays/assets/js/65.a310d4e8.js"><link rel="prefetch" href="/trainingdays/assets/js/66.91ad5d91.js"><link rel="prefetch" href="/trainingdays/assets/js/67.bdfc270a.js"><link rel="prefetch" href="/trainingdays/assets/js/68.7805630f.js"><link rel="prefetch" href="/trainingdays/assets/js/69.9a6edb47.js"><link rel="prefetch" href="/trainingdays/assets/js/7.3ee5fb68.js"><link rel="prefetch" href="/trainingdays/assets/js/70.2e5214af.js"><link rel="prefetch" href="/trainingdays/assets/js/71.0ed1ea53.js"><link rel="prefetch" href="/trainingdays/assets/js/72.05b27471.js"><link rel="prefetch" href="/trainingdays/assets/js/73.5cd028ca.js"><link rel="prefetch" href="/trainingdays/assets/js/74.cd61fe8d.js"><link rel="prefetch" href="/trainingdays/assets/js/75.8c8f40ca.js"><link rel="prefetch" href="/trainingdays/assets/js/76.50f7afaf.js"><link rel="prefetch" href="/trainingdays/assets/js/77.a0e160e0.js"><link rel="prefetch" href="/trainingdays/assets/js/78.c8465bf5.js"><link rel="prefetch" href="/trainingdays/assets/js/79.458fd2c0.js"><link rel="prefetch" href="/trainingdays/assets/js/8.3f86f0a0.js"><link rel="prefetch" href="/trainingdays/assets/js/80.454f4426.js"><link rel="prefetch" href="/trainingdays/assets/js/81.ed2d010d.js"><link rel="prefetch" href="/trainingdays/assets/js/82.cd4bb1c0.js"><link rel="prefetch" href="/trainingdays/assets/js/83.e3b63896.js"><link rel="prefetch" href="/trainingdays/assets/js/84.af75ea47.js"><link rel="prefetch" href="/trainingdays/assets/js/85.728f265c.js"><link rel="prefetch" href="/trainingdays/assets/js/86.e93b6d39.js"><link rel="prefetch" href="/trainingdays/assets/js/87.d5748615.js"><link rel="prefetch" href="/trainingdays/assets/js/9.b9da79d5.js">
    <link rel="stylesheet" href="/trainingdays/assets/css/0.styles.8d7a09fd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/trainingdays/" class="home-link router-link-active"><!----> <span class="site-name">Azure Developer College</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/trainingdays/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/trainingdays/day1/" class="sidebar-link">Day 1 Azure Fundamentals &amp; Infrastructure</a></li><li><a href="/trainingdays/day2/" class="sidebar-link">Day 2 Azure Development</a></li><li><a href="/trainingdays/day3/" class="sidebar-link">Day 3 Data and AI</a></li><li><a href="/trainingdays/day4/" class="sidebar-link">Day 4 DevOps and Monitoring</a></li><li><a href="/trainingdays/day5/" class="sidebar-link">Day 5 Identity and Architecture</a></li><li><a href="/trainingdays/day6/" class="sidebar-link">Day 6 Containerization</a></li><li><a href="/trainingdays/day7/" aria-current="page" class="sidebar-link">Day 7 Kubernetes</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="challenge-4-deploy-a-microservice-oriented-sample-application"><a href="#challenge-4-deploy-a-microservice-oriented-sample-application" class="header-anchor">#</a> Challenge 4: Deploy a Microservice-Oriented Sample Application</h1> <h2 id="here-is-what-you-will-learn-🎯"><a href="#here-is-what-you-will-learn-🎯" class="header-anchor">#</a> Here is what you will learn 🎯</h2> <p>In this challenge you will apply what you have learned in the previous challenges to our Contacts API i.e. you will deploy the Simple Contacts Management (SCM) application to your Kubernetes cluster.</p> <h1 id="table-of-contents"><a href="#table-of-contents" class="header-anchor">#</a> Table Of Contents</h1> <ol><li><a href="#architecture">Architecture</a></li> <li><a href="#terraform-deploy-azure-infrastructure">Terraform - Deploy Azure Infrastructure</a></li> <li><a href="#deploy-configuration-secrets">Deploy Configuration / Secrets</a></li> <li><a href="#build-all-required-docker-images">Build all required Docker Images</a></li> <li><a href="#deploy-backend-apis">Deploy Backend APIs</a></li> <li><a href="#deploy-functions-daemon-services">Deploy Functions / Daemon Services</a></li> <li><a href="#deploy-ui">Deploy UI</a></li> <li><a href="#check">Check</a></li> <li><a href="#monitoring-optional">Monitoring (Optional)</a></li> <li><a href="#wrap-up">Wrap-Up</a></li></ol> <h2 id="architecture"><a href="#architecture" class="header-anchor">#</a> Architecture</h2> <p>We have been working with the Contacts API now for some time. Let's deploy the &quot;full-blown&quot; Simple Contacts Management (SCM) app to your Kubernetes cluster.</p> <p>To give you an impression how this will look like in the end, here are some screenshots:</p> <p><img src="/trainingdays/assets/img/app_home.86aecc4f.png" alt="app_home"> <img src="/trainingdays/assets/img/app_contacts.5add1a21.png" alt="app_contacts"> <img src="/trainingdays/assets/img/app_contact_details.0743224b.png" alt="app_contacts_details"> <img src="/trainingdays/assets/img/app_stats.76b9a17b.png" alt="app_stats"></p> <p>The application is capable managing contacts and visit reports via a modern, responsive UI that is written in <a href="https://vuejs.org" target="_blank" rel="noopener noreferrer">VueJS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>It makes use of several Azure services to have a good UX, e.g. indexing contacts in an <a href="https://docs.microsoft.com/azure/search/search-what-is-azure-search" target="_blank" rel="noopener noreferrer">Azure Search service<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to give users the possibility to search for contacts anywhere in the app, send visit report results to an <a href="https://docs.microsoft.com/azure/cognitive-services/text-analytics/" target="_blank" rel="noopener noreferrer">Azure Congitive Service<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> instance to analyze the sentiment of the result description etc.</p> <p>We also followed a microservice approach by giving each service its own data store (<a href="https://docs.microsoft.com/azure/azure-sql/" target="_blank" rel="noopener noreferrer">Azure SQL DB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for contacts service, <a href="https://docs.microsoft.com/azure/cosmos-db/" target="_blank" rel="noopener noreferrer">Cosmos DB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for visit reports service etc.).</p> <p>Under the hood, services communicate with each other by sending messages over an <a href="https://docs.microsoft.com/azure/service-bus-messaging/" target="_blank" rel="noopener noreferrer">Azure Service Bus<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> instance via several topics so that we can guarantee that each services operates on its own. Some of these messages are also handled by &quot;background/daemon&quot;-services which we implemented by using the <a href="https://docs.microsoft.com/azure/azure-functions/functions-create-function-linux-custom-image?tabs=bash%2Cportal&amp;pivots=programming-language-csharp" target="_blank" rel="noopener noreferrer">Azure Functions runtime<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - yes, you can host Azure Functions via Docker containers (see <a href="https://docs.microsoft.com/azure/azure-functions/functions-create-function-linux-custom-image?tabs=bash%2Cportal&amp;pivots=programming-language-csharp" target="_blank" rel="noopener noreferrer">Create a function on Linux using a custom container<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for details)!</p> <p>That said, we are also following the best practice to push all possible state of the application out of your cluster. That means, we won't host any database within the cluster. Stateless clusters are much easier to manage!</p> <p>This is how the architecture looks like after deploying Azure and in-cluster services:</p> <p><img src="/trainingdays/assets/img/aks_arch.65d78571.png" alt="architecture"></p> <h2 id="terraform-deploy-azure-infrastructure"><a href="#terraform-deploy-azure-infrastructure" class="header-anchor">#</a> Terraform - Deploy Azure Infrastructure</h2> <p>To create the Azure infrastructure, we are using <a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, a very popular tool in the &quot;Infrastructure-as-Code&quot; space.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>📝 If you haven't installed it already, please follow the official tutorial: <a href="https://www.terraform.io/downloads.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/downloads.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <p>If you have successfully installed the Terrraform CLI, let's create the Azure service, we need.</p> <p>Go to folder <code>day7/challenges/samples/challenge-4/0_tf</code> and open the file <code>variables.tf</code>. You need to adjust a few settings:</p> <ul><li>default value of <code>location</code> - choose the same location as your AKS cluster to create all services in the same location</li> <li>default value of <code>prefix</code> - we use a prefix to have consistent naming of services. Please choose one that fits for you, but be careful to <strong>not</strong> use more than <strong>6</strong> characters for it.</li></ul> <p>You can leave all other variables with their default values. The file should then look similar to that:</p> <div class="language-hcl extra-class"><pre class="language-hcl"><code><span class="token keyword">variable<span class="token type variable"> &quot;location&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span>    <span class="token punctuation">=</span> string
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">&quot;westeurope&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;prefix&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span>    <span class="token punctuation">=</span> string
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">&quot;mydcd7&quot;</span>
  <span class="token keyword">validation</span> <span class="token punctuation">{</span>
    <span class="token property">condition</span>     <span class="token punctuation">=</span> length(var.prefix) &lt;<span class="token punctuation">=</span> <span class="token number">6</span>
    <span class="token property">error_message</span> <span class="token punctuation">=</span> <span class="token string">&quot;The prefix value must not be longer than 6 characters.&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;env&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span>    <span class="token punctuation">=</span> string
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">&quot;dev&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;cosmosdbname&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span>    <span class="token punctuation">=</span> string
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">&quot;scmvisitreports&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;cosmoscontainername&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span>    <span class="token punctuation">=</span> string
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">&quot;visitreports&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;sqldbusername&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span>    <span class="token punctuation">=</span> string
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">&quot;adcsqladmin&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">variable<span class="token type variable"> &quot;sqldbpassword&quot; </span></span><span class="token punctuation">{</span>
  <span class="token property">type</span>    <span class="token punctuation">=</span> string
  <span class="token property">default</span> <span class="token punctuation">=</span> <span class="token string">&quot;Ch@ngeMe!123!&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>After adjusting the file, you can execute the following commands (in folder <code>day7/challenges/samples/challenge-4/0_tf</code>):</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ terraform init
$ terraform apply
<span class="token comment"># Answer with 'yes' when asked, that the changes will be applied.</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>📝 If you get an error because of the validation section in the <code>variables.tf</code> file, you probably used an older version of <code>terraform</code>. If you don't want to update to a newer version, just remove that section.</p></div> <p><strong>This will take up to 20 minutes to finish</strong> - grab a coffee ☕</p> <p>After the script has successfully finished, save the variables/secrets from Azure to a file:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>terraform output <span class="token parameter variable">-json</span> <span class="token operator">&gt;</span> azure_output.json
</code></pre></div><h2 id="create-a-new-kubernetes-namespace"><a href="#create-a-new-kubernetes-namespace" class="header-anchor">#</a> Create a new Kubernetes Namespace</h2> <p>We will put our application into a namespace called <code>contactsapp</code>. Let's create it:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl create ns contactsapp

namespace/contactsapp created
</code></pre></div><p>We set the new namespace as the current <em>default one</em>. Otherwise, we would always have to append <code>--namespace contactsapp</code> to our commands:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl config set-context <span class="token parameter variable">--current</span> <span class="token parameter variable">--namespace</span><span class="token operator">=</span>contactsapp

Context <span class="token string">&quot;adc-cluster&quot;</span> modified.

<span class="token comment"># to reset the namespace later back to 'default', use 'kubectl config set-context --current --namespace=default'</span>
</code></pre></div><h2 id="deploy-configuration-secrets"><a href="#deploy-configuration-secrets" class="header-anchor">#</a> Deploy Configuration / Secrets</h2> <p>Now we have to create two configuration objects that we use to read the Azure configuration within the Kubernetes cluster: a <code>Secret</code> and a <code>ConfigMap</code>.</p> <p>Go to <code>day7/challenges/samples/challenge-4/1_config</code> and replace the placeholders <code>#{var_name}#</code> in the file <code>secrets.yaml</code> with the corresponding value from the <code>azure_output.txt</code> file.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>📝 There is a bash script called <code>replace_variables.sh</code> in the same directory that you can use to automatically create the <code>ConfigMap</code> and <code>Secret</code> file for you.</p> <p><strong>Prerequisite:</strong> You need the <a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer">jq<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> tool installed in the environment you are running the script. If you are using Azure Shell, you are good to go.</p> <p>Just run it and it will produce two files called <code>local-configmap.yaml</code> and <code>local-secrets.yaml</code> (the script will keep the original files untouched). Use the <code>local</code> versions for deployment:</p></div> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> scmsecrets
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">'APPINSIGHTSKEY'</span><span class="token punctuation">:</span> <span class="token string">'#{appinsights_base64}#'</span>
  <span class="token key atrule">'CONTACTSLISTENCONNSTR'</span><span class="token punctuation">:</span> <span class="token string">'#{contacts_listen_connectionstring_base64}#'</span>
  <span class="token key atrule">'CONTACTSLISTENENTITYCONNSTR'</span><span class="token punctuation">:</span> <span class="token string">'#{contacts_listen_with_entity_connectionstring_base64}#'</span>
  <span class="token key atrule">'CONTACTSSENDCONNSTR'</span><span class="token punctuation">:</span> <span class="token string">'#{contacts_send_connectionstring_base64}#'</span>
  <span class="token key atrule">'COSMOSENDPOINT'</span><span class="token punctuation">:</span> <span class="token string">'#{cosmos_endpoint_base64}#'</span>
  <span class="token key atrule">'COSMOSPRIMARYKEY'</span><span class="token punctuation">:</span> <span class="token string">'#{cosmos_primary_master_key_base64}#'</span>
  <span class="token key atrule">'RESOURCESCONNECTIONSTRING'</span><span class="token punctuation">:</span> <span class="token string">'#{resources_primary_connection_string_base64}#'</span>
  <span class="token key atrule">'FUNCTIONSCONNECTIONSTRING'</span><span class="token punctuation">:</span> <span class="token string">'#{funcs_primary_connection_string_base64}#'</span>
  <span class="token key atrule">'SEARCHNAME'</span><span class="token punctuation">:</span> <span class="token string">'#{search_name_base64}#'</span>
  <span class="token key atrule">'SEARCHPRIMARYKEY'</span><span class="token punctuation">:</span> <span class="token string">'#{search_primary_key_base64}#'</span>
  <span class="token key atrule">'SQLDBCONNECTIONSTRING'</span><span class="token punctuation">:</span> <span class="token string">'#{sqldb_connectionstring_base64}#'</span>
  <span class="token key atrule">'TAENDPOINT'</span><span class="token punctuation">:</span> <span class="token string">'#{textanalytics_endpoint_base64}#'</span>
  <span class="token key atrule">'TAKEY'</span><span class="token punctuation">:</span> <span class="token string">'#{textanalytics_key_base64}#'</span>
  <span class="token key atrule">'THUMBNAILLISTENCONNSTR'</span><span class="token punctuation">:</span> <span class="token string">'#{thumbnail_listen_connectionstring_base64}#'</span>
  <span class="token key atrule">'THUMBNAILSENDCONNSTR'</span><span class="token punctuation">:</span> <span class="token string">'#{thumbnail_send_connectionstring_base64}#'</span>
  <span class="token key atrule">'VRLISTENCONNSTR'</span><span class="token punctuation">:</span> <span class="token string">'#{visitreports_listen_connectionstring_base64}#'</span>
  <span class="token key atrule">'VRSENDCONNSTR'</span><span class="token punctuation">:</span> <span class="token string">'#{visitreports_send_connectionstring_base64}#'</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>⚠️ The value of a variable should <strong>not contain</strong> the opening/closing tags anymore, e.g. <code>'APPINSIGHTSKEY': '1234567890'</code>.</p></div> <p>Do the same with the file <code>configmap.yaml</code>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> uisettings
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">settings.js</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    var uisettings = <span class="token punctuation">{</span>
      <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> <span class="token string">'/api/contacts/'</span><span class="token punctuation">,</span>
      <span class="token key atrule">resourcesEndpoint</span><span class="token punctuation">:</span> <span class="token string">'/api/resources/'</span><span class="token punctuation">,</span>
      <span class="token key atrule">searchEndpoint</span><span class="token punctuation">:</span> <span class="token string">'/api/search/'</span><span class="token punctuation">,</span>
      <span class="token key atrule">reportsEndpoint</span><span class="token punctuation">:</span> <span class="token string">'/api/visitreports/'</span><span class="token punctuation">,</span>
      <span class="token key atrule">enableStats</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
      <span class="token key atrule">aiKey</span><span class="token punctuation">:</span> <span class="token string">'#{appinsights}#'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>📝 Be careful: in this <code>ConfigMap</code> the AppInsights Key (<code>aiKey</code>) is <strong>not</strong> the base64-encoded one!</p></div> <p>Please apply both files to your cluster. If you ran the <code>replace_variables.sh</code> script, the files are <code>local-configmap.yaml</code> and <code>local-secrets.yaml</code>:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> configmap.yaml
configmap/uisettings created

$ kubectl apply <span class="token parameter variable">-f</span> secrets.yaml
secret/scmsecrets created
</code></pre></div><h2 id="build-all-required-docker-images"><a href="#build-all-required-docker-images" class="header-anchor">#</a> Build all required Docker images</h2> <p>Now we need to build all Docker images for our application. In total, we will have <strong>8</strong> images in our repository after this task. For convenience reasons, we build all images in the container registry!</p> <p>Now, build all the required images one by one.</p> <p>Therefore first create a shell variable <code>ACR_NAME</code> with the name of your container registry like this:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">ACR_NAME</span><span class="token operator">=</span>yourRegistryNameHere
</code></pre></div><p>This variable is used for all the following Docker builds in ACR. Go to the root directory of the repository <code>trainingdays</code> and fire all docker builds one after another:</p> <ol><li>Contacts API:</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az acr build <span class="token parameter variable">-r</span> <span class="token variable">$ACR_NAME</span> <span class="token parameter variable">-t</span> <span class="token variable">$ACR_NAME</span>.azurecr.io/adc-contacts-api:2.0 <span class="token parameter variable">-f</span> ./day7/apps/dotnetcore/Scm/Adc.Scm.Api/Dockerfile ./day7/apps/dotnetcore/Scm
</code></pre></div><ol start="2"><li>Resources API:</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az acr build <span class="token parameter variable">-r</span> <span class="token variable">$ACR_NAME</span> <span class="token parameter variable">-t</span> <span class="token variable">$ACR_NAME</span>.azurecr.io/adc-resources-api:2.0 ./day7/apps/dotnetcore/Scm.Resources/Adc.Scm.Resources.Api
</code></pre></div><ol start="3"><li>Image Resizer Function:</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az acr build <span class="token parameter variable">-r</span> <span class="token variable">$ACR_NAME</span> <span class="token parameter variable">-t</span> <span class="token variable">$ACR_NAME</span>.azurecr.io/adc-resources-func:2.0 ./day7/apps/dotnetcore/Scm.Resources/Adc.Scm.Resources.ImageResizer
</code></pre></div><ol start="4"><li>Search API:</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az acr build <span class="token parameter variable">-r</span> <span class="token variable">$ACR_NAME</span> <span class="token parameter variable">-t</span> <span class="token variable">$ACR_NAME</span>.azurecr.io/adc-search-api:2.0 ./day7/apps/dotnetcore/Scm.Search/Adc.Scm.Search.Api
</code></pre></div><ol start="5"><li>Search Indexer Function:</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az acr build <span class="token parameter variable">-r</span> <span class="token variable">$ACR_NAME</span> <span class="token parameter variable">-t</span> <span class="token variable">$ACR_NAME</span>.azurecr.io/adc-search-func:2.0 ./day7/apps/dotnetcore/Scm.Search/Adc.Scm.Search.Indexer
</code></pre></div><ol start="6"><li>Visit Reports API:</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az acr build <span class="token parameter variable">-r</span> <span class="token variable">$ACR_NAME</span> <span class="token parameter variable">-t</span> <span class="token variable">$ACR_NAME</span>.azurecr.io/adc-visitreports-api:2.0 ./day7/apps/nodejs/visitreport
</code></pre></div><ol start="7"><li>Text Analytics Function:</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az acr build <span class="token parameter variable">-r</span> <span class="token variable">$ACR_NAME</span> <span class="token parameter variable">-t</span> <span class="token variable">$ACR_NAME</span>.azurecr.io/adc-textanalytics-func:2.0 ./day7/apps/nodejs/textanalytics
</code></pre></div><ol start="8"><li>Frontend / UI:</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az acr build <span class="token parameter variable">-r</span> <span class="token variable">$ACR_NAME</span> <span class="token parameter variable">-t</span> <span class="token variable">$ACR_NAME</span>.azurecr.io/adc-frontend-ui:2.0 ./day7/apps/frontend/scmfe
</code></pre></div><p>Now, all images are present in your container registry. You can check the repositories in the portal, if you want:</p> <p><img src="/trainingdays/assets/img/acr_portal.a34c031e.png" alt="acr_portal"></p> <h2 id="deploy-backend-apis"><a href="#deploy-backend-apis" class="header-anchor">#</a> Deploy Backend APIs</h2> <p>We are now all set to deploy the services to the Kubernetes cluster.</p> <p>But first, we need to do some clean-up. We created ingress definitions in <a href="/trainingdays/day7/challenges/challenge-2.html#create-ingress-definitions">challenge 2</a> that would now interfere with the ones we will be creating in this challenge.</p> <p>So let's clean up these old ingress definitions:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl delete ingress ing-frontend <span class="token parameter variable">-n</span> default
kubectl delete ingress ing-contacts <span class="token parameter variable">-n</span> default
</code></pre></div><p>We are ready to deploy the API services (contacts, resources, search, visitreport APIs) to the cluster now. Each of these services comprises a <code>Deployment</code>, a <code>ClusterIP Service</code> and an <code>Ingress</code> definition.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>📝 For each service, you need to adjust some variables in the predefined YAML manifests. So please carefully read the hints in each API section.</p></div> <h3 id="contacts-api"><a href="#contacts-api" class="header-anchor">#</a> Contacts API</h3> <p>Go to folder <code>day7/challenges/samples/challenge-4/2_apis</code> and adjust the <code>ca-deploy.yaml</code> and <code>ca-ingress.yaml</code> as described below.</p> <p>Settings to adjust:</p> <table><thead><tr><th>File</th> <th>Setting</th> <th>Hint</th></tr></thead> <tbody><tr><td>ca-deploy.yaml</td> <td>&lt;ACR_NAME&gt;</td> <td>Replace with the name of your Azure Container Registry, e.g. in our case here <code>adccontainerreg</code></td></tr> <tr><td>ca-ingress.yaml</td> <td>#{YOUR_HOST_NAME}#</td> <td>Replace with the nip.io domain name, e.g. <code>20-67-122-249.nip.io</code></td></tr></tbody></table> <p>Apply the definitions in the mentioned path:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> 1_contactsapi

deployment.apps/ca-deploy created
ingress.extensions/ing-contacts created
service/contactsapi created
</code></pre></div><h3 id="resources-api"><a href="#resources-api" class="header-anchor">#</a> Resources API</h3> <p>Go to folder <code>day7/challenges/samples/challenge-4/2_apis</code>and adjust the <code>resources-deploy.yaml</code> and <code>resources-ingress.yaml</code> as described below.</p> <p>Settings to adjust:</p> <table><thead><tr><th>File</th> <th>Setting</th> <th>Hint</th></tr></thead> <tbody><tr><td>resources-deploy.yaml</td> <td>&lt;ACR_NAME&gt;</td> <td>Replace with the name of your Azure Container Registry, e.g. in our case here <code>adccontainerreg</code></td></tr> <tr><td>resources-ingress.yaml</td> <td>#{YOUR_HOST_NAME}#</td> <td>Replace with the nip.io domain name, e.g. <code>20-67-122-249.nip.io</code></td></tr></tbody></table> <p>Apply the definitions in the mentioned path:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> 2_resourcesapi

deployment.apps/resources-deploy created
ingress.extensions/ing-resources created
service/resourcesapi created
</code></pre></div><h3 id="search-api"><a href="#search-api" class="header-anchor">#</a> Search API</h3> <p>Go to folder <code>day7/challenges/samples/challenge-4/2_apis</code> and adjust the <code>search-deploy.yaml</code> and <code>search-ingress.yaml</code> as described below.</p> <p>Settings to adjust:</p> <table><thead><tr><th>File</th> <th>Setting</th> <th>Hint</th></tr></thead> <tbody><tr><td>search-deploy.yaml</td> <td>&lt;ACR_NAME&gt;</td> <td>Replace with the name of your Azure Container Registry, e.g. in our case here <code>adccontainerreg</code></td></tr> <tr><td>search-ingress.yaml</td> <td>#{YOUR_HOST_NAME}#</td> <td>Replace with the nip.io domain name, e.g. <code>20-67-122-249.nip.io</code></td></tr></tbody></table> <p>Apply the definitions in the mentioned path:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> 3_searchapi

deployment.apps/search-deploy created
ingress.extensions/ing-search created
service/searchapi created
</code></pre></div><h3 id="visit-reports-api"><a href="#visit-reports-api" class="header-anchor">#</a> Visit Reports API</h3> <p>Go to folder <code>day7/challenges/samples/challenge-4/2_apis</code> and adjust the <code>visitreports-deploy.yaml</code> and <code>visitreports-ingress.yaml</code> as described below.</p> <p>Settings to adjust:</p> <table><thead><tr><th>File</th> <th>Setting</th> <th>Hint</th></tr></thead> <tbody><tr><td>visitreports-deploy.yaml</td> <td>&lt;ACR_NAME&gt;</td> <td>Replace with the name of your Azure Container Registry, e.g. in our case here <code>adccontainerreg</code></td></tr> <tr><td>visitreports-ingress.yaml</td> <td>#{YOUR_HOST_NAME}#</td> <td>Replace with the nip.io domain name, e.g. <code>20-67-122-249.nip.io</code></td></tr></tbody></table> <p>Apply the definitions in the mentioned path:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> 4_visitreports

deployment.apps/visitreports-deploy created
ingress.extensions/ing-visitreports created
service/visitreportapi created
</code></pre></div><h2 id="deploy-functions-daemon-services"><a href="#deploy-functions-daemon-services" class="header-anchor">#</a> Deploy Functions / Daemon Services</h2> <p>Next, we deploy the background/daemon services. For each of these background services, we only need a <code>Deployment</code> as they won't be called directly. Most of them listen for messages of the Azure Service Bus we already created.</p> <p>So, same procedure as before.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>📝 For each service, you need to adjust some variables in the predefined YAML manifests. So please carefully read the hints in each API section.</p></div> <h3 id="resources-image-resizer"><a href="#resources-image-resizer" class="header-anchor">#</a> Resources / Image Resizer</h3> <p>Go to folder <code>day7/challenges/samples/challenge-4/3_functions</code> and adjust the <code>resources-function-deploy.yaml</code> as described below.</p> <p>Settings to adjust:</p> <table><thead><tr><th>File</th> <th>Setting</th> <th>Hint</th></tr></thead> <tbody><tr><td>resources-function-deploy.yaml</td> <td>&lt;ACR_NAME&gt;</td> <td>Replace with the name of your Azure Container Registry, e.g. in our case here <code>adccontainerreg</code></td></tr></tbody></table> <p>Apply the definitions in the mentioned path:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> 1_resourcesfunc

deployment.apps/resources-function-deploy created
</code></pre></div><h3 id="search-contacts-indexer"><a href="#search-contacts-indexer" class="header-anchor">#</a> Search / Contacts Indexer</h3> <p>Go to folder <code>day7/challenges/samples/challenge-4/3_functions</code> and adjust the <code>search-function-deploy.yaml</code> as described below.</p> <p>Settings to adjust:</p> <table><thead><tr><th>File</th> <th>Setting</th> <th>Hint</th></tr></thead> <tbody><tr><td>search-function-deploy.yaml</td> <td>&lt;ACR_NAME&gt;</td> <td>Replace with the name of your Azure Container Registry, e.g. in our case here <code>adccontainerreg</code></td></tr></tbody></table> <p>Apply the definitions in the mentioned path:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> 2_searchfunc

deployment.apps/search-function-deploy created
</code></pre></div><h3 id="text-analytics-visit-reports-sentiment-analysis"><a href="#text-analytics-visit-reports-sentiment-analysis" class="header-anchor">#</a> Text Analytics / Visit Reports Sentiment Analysis</h3> <p>Go to folder <code>day7/challenges/samples/challenge-4/3_functions</code> and adjust the <code>textanalytics-function-deploy.yaml</code> as described below.</p> <p>Settings to adjust:</p> <table><thead><tr><th>File</th> <th>Setting</th> <th>Hint</th></tr></thead> <tbody><tr><td>textanalytics-function-deploy.yaml</td> <td>&lt;ACR_NAME&gt;</td> <td>Replace with the name of your Azure Container Registry, e.g. in our case here <code>adccontainerreg</code></td></tr></tbody></table> <p>Apply the definitions in the mentioned path:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> 3_textanalyticsfunc

deployment.apps/textanalytics-function-deploy created
</code></pre></div><h2 id="deploy-ui"><a href="#deploy-ui" class="header-anchor">#</a> Deploy UI</h2> <p>Last, but not least, we also need to deploy the VueJS Single Page Application.</p> <p>Go to folder <code>day7/challenges/samples/challenge-4/4_frontend</code> and adjust the <code>ui-deploy.yaml</code> and <code>ui-ingress.yaml</code> as described below.</p> <p>Settings to adjust:</p> <table><thead><tr><th>File</th> <th>Setting</th> <th>Hint</th></tr></thead> <tbody><tr><td>ui-deploy.yaml</td> <td>&lt;ACR_NAME&gt;</td> <td>Replace with the name of your Azure Container Registry, e.g. in our case here <code>adccontainerreg</code></td></tr> <tr><td>ui-ingress.yaml</td> <td>#{YOUR_HOST_NAME}#</td> <td>Replace with the nip.io domain name, e.g. <code>20-67-122-249.nip.io</code></td></tr></tbody></table> <p>Apply the definitions in the mentioned path:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> 1_ui

deployment.apps/frontend-deploy created
ingress.extensions/ing-frontend created
service/frontend created
</code></pre></div><h2 id="check"><a href="#check" class="header-anchor">#</a> Check</h2> <p>That was a lot of manual typing and, of course, errors happen when doing so. Let's check the state of the cluster:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get deployment,pods,service,endpoints,ingress
NAME                                            READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ca-deploy                       <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           23h
deployment.apps/frontend-deploy                 <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           22h
deployment.apps/resources-deploy                <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           23h
deployment.apps/resources-function-deploy       <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           22h
deployment.apps/search-deploy                   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           22h
deployment.apps/search-function-deploy          <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           22h
deployment.apps/textanalytics-function-deploy   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           22h
deployment.apps/visitreports-deploy             <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           22h

NAME                                                 READY   STATUS    RESTARTS   AGE
pod/ca-deploy-75bcd947f8-gbppf                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          23h
pod/ca-deploy-75bcd947f8-mpkdd                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          23h
pod/frontend-deploy-76d6fdfd85-mpcnj                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h
pod/frontend-deploy-76d6fdfd85-xwvfv                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h
pod/resources-deploy-7567764b6b-fbwmg                <span class="token number">1</span>/1     Running   <span class="token number">0</span>          23h
pod/resources-deploy-7567764b6b-pkpvg                <span class="token number">1</span>/1     Running   <span class="token number">0</span>          23h
pod/resources-function-deploy-5f8487bc8f-96nq7       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h
pod/resources-function-deploy-5f8487bc8f-b7b5z       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h
pod/search-deploy-656c589d54-fvnf5                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h
pod/search-deploy-656c589d54-t28m2                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h
pod/search-function-deploy-85497fb7bc-6mph7          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h
pod/search-function-deploy-85497fb7bc-wzrhx          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h
pod/textanalytics-function-deploy-6884ccdb5b-2fch5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h
pod/textanalytics-function-deploy-6884ccdb5b-ccnzm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h
pod/visitreports-deploy-7d774598b6-dk6zs             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h
pod/visitreports-deploy-7d774598b6-zx5ds             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22h

NAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
service/contactsapi      ClusterIP   <span class="token number">10.0</span>.233.94    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   23h
service/frontend         ClusterIP   <span class="token number">10.0</span>.183.66    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   22h
service/resourcesapi     ClusterIP   <span class="token number">10.0</span>.64.143    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   23h
service/searchapi        ClusterIP   <span class="token number">10.0</span>.145.162   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   22h
service/visitreportapi   ClusterIP   <span class="token number">10.0</span>.148.56    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   22h

NAME                       ENDPOINTS                           AGE
endpoints/contactsapi      <span class="token number">10.244</span>.0.40:5000,10.244.2.25:5000   23h
endpoints/frontend         <span class="token number">10.244</span>.1.19:80,10.244.2.32:80       22h
endpoints/resourcesapi     <span class="token number">10.244</span>.0.41:5000,10.244.2.26:5000   23h
endpoints/searchapi        <span class="token number">10.244</span>.0.42:5000,10.244.2.27:5000   22h
endpoints/visitreportapi   <span class="token number">10.244</span>.1.17:3000,10.244.2.28:3000   22h

NAME                                  HOSTS                  ADDRESS         PORTS   AGE
ingress.extensions/ing-contacts       <span class="token number">20</span>-67-122-249.nip.io   <span class="token number">20.67</span>.122.249   <span class="token number">80</span>      23h
ingress.extensions/ing-frontend       <span class="token number">20</span>-67-122-249.nip.io   <span class="token number">20.67</span>.122.249   <span class="token number">80</span>      22h
ingress.extensions/ing-resources      <span class="token number">20</span>-67-122-249.nip.io   <span class="token number">20.67</span>.122.249   <span class="token number">80</span>      23h
ingress.extensions/ing-search         <span class="token number">20</span>-67-122-249.nip.io   <span class="token number">20.67</span>.122.249   <span class="token number">80</span>      22h
ingress.extensions/ing-visitreports   <span class="token number">20</span>-67-122-249.nip.io   <span class="token number">20.67</span>.122.249   <span class="token number">80</span>      22h
</code></pre></div><p>You should see a similar output, having 8 deployments, 16 pods (each deployment set <code>replicas: 2</code>), 5 services with corresponding endpoints and 5 ingress definitions.</p> <p>If that is the case, open a browser and navigate to you nip.io domain and give it a try!</p> <p>Create contacts, create visit reports for an existing contact, search via the search bar at the top of the website and have a look at the statistics.</p> <h2 id="monitoring-optional"><a href="#monitoring-optional" class="header-anchor">#</a> Monitoring (Optional)</h2> <p>In case you missed it, we already created a service that is helping you with monitoring your application running in the Kubernetes cluster: <em>Application Insights</em>.</p> <p>Each service (API, background service, frontend) is communicating with Application Insights via the instrumentation key and sending telemetry data like, request/response time, errors that may have occured, how your users navigate through the frontend.</p> <p>Navigate to the Application Insights component in the Azure Portal and check the data that is sent to that service:</p> <h3 id="application-map"><a href="#application-map" class="header-anchor">#</a> Application Map</h3> <p><img src="/trainingdays/assets/img/monitoring_map.4f783279.png" alt="map"> <img src="/trainingdays/assets/img/monitoring_error.84405fd4.png" alt="map"></p> <h3 id="application-performance"><a href="#application-performance" class="header-anchor">#</a> Application Performance</h3> <p><img src="/trainingdays/assets/img/monitoring_performance.0cd6a32f.png" alt="map"></p> <h3 id="application-user-events-frontend-integration"><a href="#application-user-events-frontend-integration" class="header-anchor">#</a> Application User Events / Frontend Integration</h3> <p><img src="/trainingdays/assets/img/monitoring_userevents.48f6cb58.png" alt="map"></p> <h3 id="application-end2end-transactions"><a href="#application-end2end-transactions" class="header-anchor">#</a> Application End2End Transactions</h3> <p><img src="/trainingdays/assets/img/monitoring_end2end.27448a3c.png" alt="map"></p> <h3 id="application-dashboard"><a href="#application-dashboard" class="header-anchor">#</a> Application Dashboard</h3> <p>You can also create an application dashboard by clicking on <code>Application Dashboard</code> on the overview page of the Application Insights component.</p> <p><img src="/trainingdays/assets/img/monitoring_dashboard.c32d4881.png" alt="map"></p> <h2 id="wrap-up"><a href="#wrap-up" class="header-anchor">#</a> Wrap-Up</h2> <p>🎉 <strong><em>Congratulations</em></strong> 🎉</p> <p>You have successfully deployed a full-blown, microservice-oriented application to your AKS cluster.</p> <p><a href="/trainingdays/day7/challenges/challenge-3.html">◀ Previous challenge</a> | <a href="/trainingdays/day7/" class="router-link-active">🔼 Day 7</a> | <a href="/trainingdays/day7/challenges/bonus-1.html">Next challenge ▶</a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azuredevcollege/trainingdays/edit/master/day7/challenges/challenge-4.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/trainingdays/assets/js/app.e8a6fdbf.js" defer></script><script src="/trainingdays/assets/js/3.9b3cf7d1.js" defer></script><script src="/trainingdays/assets/js/15.74de6942.js" defer></script>
  </body>
</html>
