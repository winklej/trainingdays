<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Bonus (optional): Secure Endpoints with SSL Certificates | Azure Developer College</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/trainingdays/assets/css/0.styles.8d7a09fd.css" as="style"><link rel="preload" href="/trainingdays/assets/js/app.e8a6fdbf.js" as="script"><link rel="preload" href="/trainingdays/assets/js/3.9b3cf7d1.js" as="script"><link rel="preload" href="/trainingdays/assets/js/57.5f879cc0.js" as="script"><link rel="prefetch" href="/trainingdays/assets/js/10.5e63eee4.js"><link rel="prefetch" href="/trainingdays/assets/js/11.52cdb15c.js"><link rel="prefetch" href="/trainingdays/assets/js/12.dd68cce1.js"><link rel="prefetch" href="/trainingdays/assets/js/13.968f15e4.js"><link rel="prefetch" href="/trainingdays/assets/js/14.6107e61f.js"><link rel="prefetch" href="/trainingdays/assets/js/15.74de6942.js"><link rel="prefetch" href="/trainingdays/assets/js/16.bf550880.js"><link rel="prefetch" href="/trainingdays/assets/js/17.25c2442d.js"><link rel="prefetch" href="/trainingdays/assets/js/18.df448a3a.js"><link rel="prefetch" href="/trainingdays/assets/js/19.57fc59b2.js"><link rel="prefetch" href="/trainingdays/assets/js/2.5f4f93ed.js"><link rel="prefetch" href="/trainingdays/assets/js/20.b16a4364.js"><link rel="prefetch" href="/trainingdays/assets/js/21.f120af84.js"><link rel="prefetch" href="/trainingdays/assets/js/22.a29f663d.js"><link rel="prefetch" href="/trainingdays/assets/js/23.2e9fa4d5.js"><link rel="prefetch" href="/trainingdays/assets/js/24.df3c97d4.js"><link rel="prefetch" href="/trainingdays/assets/js/25.d7157d1b.js"><link rel="prefetch" href="/trainingdays/assets/js/26.8b935eca.js"><link rel="prefetch" href="/trainingdays/assets/js/27.fab398a7.js"><link rel="prefetch" href="/trainingdays/assets/js/28.f45e3c7c.js"><link rel="prefetch" href="/trainingdays/assets/js/29.1ebc26ec.js"><link rel="prefetch" href="/trainingdays/assets/js/30.6728cb2f.js"><link rel="prefetch" href="/trainingdays/assets/js/31.0447b951.js"><link rel="prefetch" href="/trainingdays/assets/js/32.7ba3de54.js"><link rel="prefetch" href="/trainingdays/assets/js/33.1886053c.js"><link rel="prefetch" href="/trainingdays/assets/js/34.71397a5c.js"><link rel="prefetch" href="/trainingdays/assets/js/35.3f4903ee.js"><link rel="prefetch" href="/trainingdays/assets/js/36.ca5c6cd3.js"><link rel="prefetch" href="/trainingdays/assets/js/37.150f3aea.js"><link rel="prefetch" href="/trainingdays/assets/js/38.267b0401.js"><link rel="prefetch" href="/trainingdays/assets/js/39.b63e5745.js"><link rel="prefetch" href="/trainingdays/assets/js/4.51ff6f02.js"><link rel="prefetch" href="/trainingdays/assets/js/40.ccce5e2d.js"><link rel="prefetch" href="/trainingdays/assets/js/41.8d1a41f2.js"><link rel="prefetch" href="/trainingdays/assets/js/42.b2565944.js"><link rel="prefetch" href="/trainingdays/assets/js/43.b9bb36ce.js"><link rel="prefetch" href="/trainingdays/assets/js/44.0cb215c3.js"><link rel="prefetch" href="/trainingdays/assets/js/45.ed0b28e2.js"><link rel="prefetch" href="/trainingdays/assets/js/46.d7dc415d.js"><link rel="prefetch" href="/trainingdays/assets/js/47.94e659f8.js"><link rel="prefetch" href="/trainingdays/assets/js/48.22da67bb.js"><link rel="prefetch" href="/trainingdays/assets/js/49.d0cc21bd.js"><link rel="prefetch" href="/trainingdays/assets/js/5.8a1a1dd9.js"><link rel="prefetch" href="/trainingdays/assets/js/50.fc76ce90.js"><link rel="prefetch" href="/trainingdays/assets/js/51.49e6933d.js"><link rel="prefetch" href="/trainingdays/assets/js/52.b3007d12.js"><link rel="prefetch" href="/trainingdays/assets/js/53.ce74ac77.js"><link rel="prefetch" href="/trainingdays/assets/js/54.0ae1433b.js"><link rel="prefetch" href="/trainingdays/assets/js/55.84f6f655.js"><link rel="prefetch" href="/trainingdays/assets/js/56.8abf9a8b.js"><link rel="prefetch" href="/trainingdays/assets/js/58.143be8bb.js"><link rel="prefetch" href="/trainingdays/assets/js/59.48d8acfe.js"><link rel="prefetch" href="/trainingdays/assets/js/6.49058ca4.js"><link rel="prefetch" href="/trainingdays/assets/js/60.a173b602.js"><link rel="prefetch" href="/trainingdays/assets/js/61.04f45b6d.js"><link rel="prefetch" href="/trainingdays/assets/js/62.c3ecf647.js"><link rel="prefetch" href="/trainingdays/assets/js/63.ad717965.js"><link rel="prefetch" href="/trainingdays/assets/js/64.3e451a8e.js"><link rel="prefetch" href="/trainingdays/assets/js/65.a310d4e8.js"><link rel="prefetch" href="/trainingdays/assets/js/66.91ad5d91.js"><link rel="prefetch" href="/trainingdays/assets/js/67.bdfc270a.js"><link rel="prefetch" href="/trainingdays/assets/js/68.7805630f.js"><link rel="prefetch" href="/trainingdays/assets/js/69.9a6edb47.js"><link rel="prefetch" href="/trainingdays/assets/js/7.3ee5fb68.js"><link rel="prefetch" href="/trainingdays/assets/js/70.2e5214af.js"><link rel="prefetch" href="/trainingdays/assets/js/71.0ed1ea53.js"><link rel="prefetch" href="/trainingdays/assets/js/72.05b27471.js"><link rel="prefetch" href="/trainingdays/assets/js/73.5cd028ca.js"><link rel="prefetch" href="/trainingdays/assets/js/74.cd61fe8d.js"><link rel="prefetch" href="/trainingdays/assets/js/75.8c8f40ca.js"><link rel="prefetch" href="/trainingdays/assets/js/76.50f7afaf.js"><link rel="prefetch" href="/trainingdays/assets/js/77.a0e160e0.js"><link rel="prefetch" href="/trainingdays/assets/js/78.c8465bf5.js"><link rel="prefetch" href="/trainingdays/assets/js/79.458fd2c0.js"><link rel="prefetch" href="/trainingdays/assets/js/8.3f86f0a0.js"><link rel="prefetch" href="/trainingdays/assets/js/80.454f4426.js"><link rel="prefetch" href="/trainingdays/assets/js/81.ed2d010d.js"><link rel="prefetch" href="/trainingdays/assets/js/82.cd4bb1c0.js"><link rel="prefetch" href="/trainingdays/assets/js/83.e3b63896.js"><link rel="prefetch" href="/trainingdays/assets/js/84.af75ea47.js"><link rel="prefetch" href="/trainingdays/assets/js/85.728f265c.js"><link rel="prefetch" href="/trainingdays/assets/js/86.e93b6d39.js"><link rel="prefetch" href="/trainingdays/assets/js/87.d5748615.js"><link rel="prefetch" href="/trainingdays/assets/js/9.b9da79d5.js">
    <link rel="stylesheet" href="/trainingdays/assets/css/0.styles.8d7a09fd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/trainingdays/" class="home-link router-link-active"><!----> <span class="site-name">Azure Developer College</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/trainingdays/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/trainingdays/day1/" class="sidebar-link">Day 1 Azure Fundamentals &amp; Infrastructure</a></li><li><a href="/trainingdays/day2/" class="sidebar-link">Day 2 Azure Development</a></li><li><a href="/trainingdays/day3/" class="sidebar-link">Day 3 Data and AI</a></li><li><a href="/trainingdays/day4/" class="sidebar-link">Day 4 DevOps and Monitoring</a></li><li><a href="/trainingdays/day5/" class="sidebar-link">Day 5 Identity and Architecture</a></li><li><a href="/trainingdays/day6/" class="sidebar-link">Day 6 Containerization</a></li><li><a href="/trainingdays/day7/" aria-current="page" class="sidebar-link">Day 7 Kubernetes</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="bonus-optional-secure-endpoints-with-ssl-certificates"><a href="#bonus-optional-secure-endpoints-with-ssl-certificates" class="header-anchor">#</a> Bonus (optional): Secure Endpoints with SSL Certificates</h1> <h2 id="here-is-what-you-will-learn-🎯"><a href="#here-is-what-you-will-learn-🎯" class="header-anchor">#</a> Here is what you will learn 🎯</h2> <p>In this optional challenge, you will learn to secure your ingress traffic using TLS (HTTPS). To facilitate the issuance and management of certificates, we will introduce a tool called <code>cert-manager</code>.</p> <p>The <code>cert-manager</code> is a Kubernetes add-on to automate the <em>management</em> and <em>issuance</em> of <em>TLS certificates</em> from various issuing sources.</p> <p>It will ensure certificates are valid and up to date periodically, and attempt to renew certificates at an appropriate time before expiry.</p> <h1 id="table-of-contents"><a href="#table-of-contents" class="header-anchor">#</a> Table Of Contents</h1> <ol><li><a href="#create-a-new-separate-namespace-for-the-cert-manager">Create a new separate Namespace for the Cert-Manager</a></li> <li><a href="#add-the-jetstack-helm-repository">Add the Jetstack Helm Repository</a></li> <li><a href="#install-the-cert-manager-helm-chart">Install the Cert-Manager Helm Chart</a></li> <li><a href="#add-a-letsencrypt-cluster-issuer">Add a LetsEncrypt Cluster Issuer</a></li> <li><a href="#update-your-frontend-ingress-configuration">Update your Frontend Ingress Configuration</a></li> <li><a href="#update-your-api-ingress-configurations">Update your API Ingress Configurations</a></li> <li><a href="#check">Check</a></li></ol> <h2 id="create-a-new-separate-namespace-for-the-cert-manager"><a href="#create-a-new-separate-namespace-for-the-cert-manager" class="header-anchor">#</a> Create a new separate Namespace for the Cert-Manager</h2> <p>To separate the <code>cert-manager</code> from the rest of our resources, let's create a new namespace:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create namespace cert-manager
</code></pre></div><h2 id="add-the-jetstack-helm-repository"><a href="#add-the-jetstack-helm-repository" class="header-anchor">#</a> Add the Jetstack Helm Repository</h2> <p><code>cert-manager</code> comes with a set of different pods and custom resources so we will use helm to install all of it's components in one go.</p> <p>First, we have to add the official repository from jetstack which contains the <code>cert-manager</code> helm chart via:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>helm repo <span class="token function">add</span> jetstack https://charts.jetstack.io
helm repo update
</code></pre></div><p>We will prepare a small configuration for the helm chart.</p> <p>Basically we want the Kubernetes <em>Custom Resource Definitions</em> to be installed together with the chart and set some default values in terms of how TLS certificates are issued for our Ingress resources:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># cert-manager-values.yaml</span>
<span class="token key atrule">installCRDs</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># install custom resource definitions</span>
<span class="token key atrule">ingressShim</span><span class="token punctuation">:</span>
  <span class="token key atrule">defaultIssuerKind</span><span class="token punctuation">:</span> ClusterIssuer
  <span class="token key atrule">defaultIssuerName</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>prod
</code></pre></div><h2 id="install-the-cert-manager-helm-chart"><a href="#install-the-cert-manager-helm-chart" class="header-anchor">#</a> Install the Cert-Manager Helm Chart</h2> <p>Now that we have prepared the configuration we can install (or upgrade) <code>cert-manager</code> using a single command:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ helm upgrade <span class="token parameter variable">-i</span> <span class="token parameter variable">-f</span> cert-manager-values.yaml <span class="token parameter variable">--namespace</span> cert-manager cert-manager jetstack/cert-manager

Release <span class="token string">&quot;cert-manager&quot;</span> does not exist. Installing it now.
NAME: cert-manager
LAST DEPLOYED: Tue Nov  <span class="token number">3</span> <span class="token number">15</span>:50:17 <span class="token number">2020</span>
NAMESPACE: cert-manager
STATUS: deployed
REVISION: <span class="token number">1</span>
TEST SUITE: None
NOTES:
cert-manager has been deployed successfully<span class="token operator">!</span>

In order to begin issuing certificates, you will need to <span class="token builtin class-name">set</span> up a ClusterIssuer
or Issuer resource <span class="token punctuation">(</span>for example, by creating a <span class="token string">'letsencrypt-staging'</span> issuer<span class="token punctuation">)</span>.

More information on the different types of issuers and how to configure them
can be found <span class="token keyword">in</span> our documentation:

https://cert-manager.io/docs/configuration/

For information on how to configure cert-manager to automatically provision
Certificates <span class="token keyword">for</span> Ingress resources, take a <span class="token function">look</span> at the <span class="token variable"><span class="token variable">`</span>ingress-shim<span class="token variable">`</span></span>
documentation:

https://cert-manager.io/docs/usage/ingress/
</code></pre></div><p>If you take a look at the Kubernetes dashboard under the <code>cert-manager</code> namespace you should see a few green deployments showing up after a few seconds:</p> <p><img src="/trainingdays/assets/img/cert-manager-workloads.dd792c6e.png" alt="cert-manager namespace on the kubernetes dashboard"></p> <h2 id="add-a-letsencrypt-cluster-issuer"><a href="#add-a-letsencrypt-cluster-issuer" class="header-anchor">#</a> Add a LetsEncrypt Cluster Issuer</h2> <p>To make <code>cert-manager</code> fully functional, we'll need to create a so called <code>Issuer</code>. <em>Issuers</em>, as their name suggests, issue TLS certificates for us.</p> <p>For our sample application, we'll rely on the free service of <a href="https://letsencrypt.org" target="_blank" rel="noopener noreferrer">letsencrypt.org<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>📝 Let’s Encrypt is a free, automated and open certificate authority (CA), run for the public’s benefit. It is a service provided by the Internet Security Research Group (ISRG).</p></div> <p>To configure Issuers (and manage the state of certificates) <code>cert-manager</code> comes with a set of Custom Resource Definitions (CRDs). CRDs are used to extend the set of existing resources in Kubernetes with custom ones. They are one of the main extension mechanisms of Kubernetes.</p> <p><code>cert-manager</code> knows two kinds of Issuers:</p> <ul><li><code>Issuer</code>: this is a namespaced resource that is only available for the namespace it is stored in.</li> <li><code>ClusterIssuer</code>: this is a cluster wide resource that is available for all namespaces.</li></ul> <p>For our example, we will create a <code>ClusterIssuer</code> since we trust all resources in our cluster.</p> <p>To define our <code>ClusterIssuer</code> we again use a YAML file that we will apply to our cluster. Let's take a look:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># letsencrypt-prod-cluster-issuer.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterIssuer
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>prod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">acme</span><span class="token punctuation">:</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//acme<span class="token punctuation">-</span>v02.api.letsencrypt.org/directory
    <span class="token key atrule">email</span><span class="token punctuation">:</span> update.your@email.com
    <span class="token key atrule">privateKeySecretRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>prod
    <span class="token key atrule">solvers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">http01</span><span class="token punctuation">:</span>
          <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
            <span class="token key atrule">class</span><span class="token punctuation">:</span> nginx
</code></pre></div><p>Don't forget to update your email-address! The email address you provide will be used by Let's Encrypt to notify you of expiring certificates.</p> <p>Hopefully you will never receive such notification because <code>cert-manager</code> should take care of the certificate renewal process for you.</p> <p>Let's apply our configuration:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> letsencrypt-prod-cluster-issuer.yaml
</code></pre></div><h2 id="update-your-frontend-ingress-configuration"><a href="#update-your-frontend-ingress-configuration" class="header-anchor">#</a> Update your Frontend Ingress Configuration</h2> <p>Only two things are missing to complete our super secure TLS setup. We need to upgrade our ingress configurations for the frontend and the API(s).</p> <p>We'll want to add two things each:</p> <ul><li>A <code>kubernetes.io/tls-acme: true</code> annotation to enable the management of the TLS certificate through cert manager.</li> <li>A <code>tls</code> section in our Ingress <code>spec</code> to define the hostname for the certificate and the name of the Kubernetes secret to store the certificate safely.</li></ul> <p>Additionally, we also tell NGINX to always redirect unencrypted traffic to use SSL (<code>nginx.ingress.kubernetes.io/ssl-redirect: 'true'</code>)</p> <p>The following shows how your <code>Ingress</code> section for the frontend deployment should look like. Make sure you don't forget to update your domain names. Usually you'll want your TLS host to match the hostname for the ingress rule you have configured:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ing<span class="token punctuation">-</span>frontend
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/enable-cors</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/cors-allow-headers</span><span class="token punctuation">:</span> <span class="token string">'Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,Accept-Language'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/cors-max-age</span><span class="token punctuation">:</span> <span class="token string">'600'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-body-size</span><span class="token punctuation">:</span> <span class="token string">'12m'</span>
    <span class="token key atrule">kubernetes.io/tls-acme</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> 20<span class="token punctuation">-</span>67<span class="token punctuation">-</span>122<span class="token punctuation">-</span>249.nip.io <span class="token comment"># this should be replaced with YOUR OWN DOMAIN</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> tls<span class="token punctuation">-</span>secret
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> 20<span class="token punctuation">-</span>67<span class="token punctuation">-</span>122<span class="token punctuation">-</span>249.nip.io <span class="token comment"># this should be replaced with YOUR OWN DOMAIN</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
            <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">service</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> frontend
                <span class="token key atrule">port</span><span class="token punctuation">:</span>
                  <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre></div><p>If you access you website again you'll notice that after a few moments it's already being served through https and that your browser is redirected to the safe endpoint automatically.</p> <h2 id="update-your-api-ingress-configurations"><a href="#update-your-api-ingress-configurations" class="header-anchor">#</a> Update your API Ingress Configurations</h2> <p>It's important not to forget to update our Ingress definitions for the other APIs as well. We would not want to deliver the static website client on a secure channel while leaving sensitive information from our APIs in the open.</p> <p>Just like we did for the frontend, we also add the <code>kubernetes.io/tls-acme: 'true'</code> and <code>nginx.ingress.kubernetes.io/ssl-redirect: 'true'</code> annotations and the <code>tls</code> configuration to the <code>spec</code> section of our other ingress configurations.</p> <p>Here is the example from the contacts API:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ing<span class="token punctuation">-</span>contacts
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/enable-cors</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/cors-allow-headers</span><span class="token punctuation">:</span> <span class="token string">'Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,Accept-Language'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/cors-max-age</span><span class="token punctuation">:</span> <span class="token string">'600'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-body-size</span><span class="token punctuation">:</span> <span class="token string">'12m'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation">:</span> <span class="token string">'/contacts/$2'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/use-regex</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
    <span class="token key atrule">kubernetes.io/tls-acme</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> 20<span class="token punctuation">-</span>67<span class="token punctuation">-</span>122<span class="token punctuation">-</span>249.nip.io <span class="token comment"># this should be replaced with YOUR OWN DOMAIN</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> tls<span class="token punctuation">-</span>secret
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> 20<span class="token punctuation">-</span>67<span class="token punctuation">-</span>122<span class="token punctuation">-</span>249.nip.io <span class="token comment"># this should be replaced with YOUR OWN DOMAIN</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /api/contacts(\/<span class="token punctuation">|</span>$)(.<span class="token important">*)</span>
            <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
            <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">service</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> contactsapi
                <span class="token key atrule">port</span><span class="token punctuation">:</span>
                  <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>⚠️ Adjust all Ingress definitions!</p> <p>You also need to adjust (and apply) <strong>all other ingress definitions</strong>, for:</p> <ul><li>Search Service</li> <li>Visit Reports Service</li> <li>Resources Service</li></ul></div> <h2 id="check"><a href="#check" class="header-anchor">#</a> Check</h2> <p>Now let's check if everything connects as expected.</p> <p>Navigate to you contacts website and use your browsers developer tools to make sure both the initial request to the website, as well as any subsequent request to the contacts API use secure HTTPS endpoints:</p> <p><img src="/trainingdays/assets/img/https-inspector.4dacbadc.png" alt="A display of the browsers developer tools"></p> <p>If both requests are being served over HTTPS were good to go!</p> <p><a href="/trainingdays/day7/challenges/challenge-4.html">◀ Previous challenge</a> | <a href="/trainingdays/day7/" class="router-link-active">🔼 Day 7</a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azuredevcollege/trainingdays/edit/master/day7/challenges/bonus-1.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/trainingdays/assets/js/app.e8a6fdbf.js" defer></script><script src="/trainingdays/assets/js/3.9b3cf7d1.js" defer></script><script src="/trainingdays/assets/js/57.5f879cc0.js" defer></script>
  </body>
</html>
